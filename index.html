<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Pflanzenlog</title>

    <style>
      :root {
        --bg0: #06150f;
        --bg1: #0b2418;
        --bg2: #0f3523;
        --glow1: rgba(34, 197, 94, 0.22);
        --glow2: rgba(132, 204, 22, 0.18);

        --card: rgba(255, 255, 255, 0.14);
        --card2: rgba(255, 255, 255, 0.1);
        --stroke: rgba(255, 255, 255, 0.22);

        --text: #ecfdf5;
        --muted: rgba(236, 253, 245, 0.7);

        --waterA: #38bdf8;
        --waterB: #2563eb;

        --fertA: #34d399;
        --fertB: #16a34a;

        --noteA: #fbbf24;
        --noteB: #f97316;

        --dangerA: #fb7185;
        --dangerB: #ef4444;

        --shadow: 0 18px 50px rgba(0, 0, 0, 0.55);
        --soft: 0 10px 26px rgba(0, 0, 0, 0.4);

        --r2: 22px;

        --font: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
      }

      * {
        box-sizing: border-box;
      }
      body {
        font-family: var(--font);
        margin: 0;
        padding: calc(16px + env(safe-area-inset-top))
          calc(16px + env(safe-area-inset-right))
          calc(16px + env(safe-area-inset-bottom))
          calc(16px + env(safe-area-inset-left));
        color: var(--text);
        background: radial-gradient(
            900px 600px at 15% 10%,
            var(--glow1),
            transparent 60%
          ),
          radial-gradient(800px 500px at 85% 20%, var(--glow2), transparent 55%),
          radial-gradient(
            900px 600px at 50% 110%,
            rgba(20, 184, 166, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      }

      h1 {
        font-size: 28px;
        letter-spacing: -0.4px;
        margin: 8px 0 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      h1 .leaf {
        width: 34px;
        height: 34px;
        display: grid;
        place-items: center;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: var(--soft);
      }
      h2 {
        font-size: 18px;
        margin: 10px 0;
      }
      h3 {
        font-size: 16px;
        margin: 10px 0;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 10px;
      }

      .card,
      .top-bar,
      .bottom-bar {
        background: linear-gradient(180deg, var(--card), var(--card2));
        border: 1px solid var(--stroke);
        border-radius: var(--r2);
        padding: 14px;
        box-shadow: var(--soft);
        backdrop-filter: blur(16px) saturate(140%);
        -webkit-backdrop-filter: blur(16px) saturate(140%);
      }

      .top-bar {
        position: sticky;
        top: 0;
        z-index: 20;
        margin-bottom: 12px;
      }
      .bottom-bar {
        position: sticky;
        bottom: 0;
        z-index: 20;
        margin-top: 12px;
      }

      #output {
        margin-top: 10px;
        color: var(--muted);
        font-size: 14px;
        min-height: 18px;
      }

      input,
      select,
      textarea {
        width: 100%;
        font-size: 16px;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        outline: none;
      }
      textarea {
        min-height: 110px;
        resize: vertical;
      }
      input::placeholder,
      textarea::placeholder {
        color: rgba(236, 253, 245, 0.55);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: rgba(34, 197, 94, 0.55);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18);
      }

      button {
        font-size: 16px;
        padding: 12px 18px;
        border-radius: 999px;
        border: 0;
        cursor: pointer;
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.2px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
        box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.28),
          0 10px 22px rgba(0, 0, 0, 0.45);
        transition: transform 0.1s ease, filter 0.15s ease,
          box-shadow 0.15s ease;
        -webkit-tap-highlight-color: transparent;
      }
      button:active {
        transform: translateY(2px) scale(0.99);
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.28),
          0 6px 16px rgba(0, 0, 0, 0.4);
      }
      button:hover {
        filter: brightness(1.06) saturate(1.08);
      }

      .btn-water {
        background: linear-gradient(135deg, var(--waterA), var(--waterB));
      }
      .btn-fert {
        background: linear-gradient(135deg, var(--fertA), var(--fertB));
      }
      .btn-note {
        background: linear-gradient(135deg, var(--noteA), var(--noteB));
      }

      .btn-ghost {
        background: rgba(255, 255, 255, 0.14);
        border: 1px solid rgba(255, 255, 255, 0.22);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      }
      .btn-danger {
        background: linear-gradient(135deg, var(--dangerA), var(--dangerB));
      }

      #calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        margin-top: 12px;
        width: 100%;
        max-width: 100%;
      }
      .card {
        overflow: hidden;
      }
      .cal-head {
        font-weight: 800;
        font-size: 12px;
        color: rgba(236, 253, 245, 0.7);
        text-align: center;
        padding: 2px 4px;
      }

      .day-btn {
        appearance: none;
        -webkit-appearance: none;

        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 22px;
        padding: 12px;
        min-height: 92px;

        background: rgba(255, 255, 255, 0.13);
        color: var(--text);
        text-align: left;

        backdrop-filter: blur(14px) saturate(140%);
        -webkit-backdrop-filter: blur(14px) saturate(140%);

        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 14px 28px rgba(0, 0, 0, 0.42);

        transition: transform 0.1s ease, box-shadow 0.14s ease,
          filter 0.14s ease;
        cursor: pointer;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      .day-btn:active {
        transform: translateY(2px) scale(0.985);
        filter: brightness(0.98);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.14),
          0 9px 18px rgba(0, 0, 0, 0.36);
      }
      .day-btn:focus-visible {
        outline: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 14px 28px rgba(0, 0, 0, 0.42), 0 0 0 3px rgba(34, 197, 94, 0.3);
      }

      .day-btn.today {
        border-color: rgba(251, 191, 36, 0.35);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 14px 28px rgba(0, 0, 0, 0.42), 0 0 0 3px rgba(251, 191, 36, 0.18);
      }
      .day-btn.selected {
        border-color: rgba(34, 197, 94, 0.45);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
          0 14px 28px rgba(0, 0, 0, 0.42), 0 0 0 3px rgba(34, 197, 94, 0.22);
      }
      .today-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 900;
        padding: 3px 8px;
        border-radius: 999px;
        margin-left: 8px;
        background: rgba(251, 191, 36, 0.18);
        border: 1px solid rgba(251, 191, 36, 0.3);
        color: rgba(236, 253, 245, 0.95);
      }

      .badges {
        margin-top: 8px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        font-size: 12px;
      }
      .badge {
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.12);
        color: rgba(236, 253, 245, 0.92);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
      }

      .badge.b-total {
        background: rgba(236, 253, 245, 0.14);
        border-color: rgba(236, 253, 245, 0.22);
      }
      .badge.b-water {
        background: rgba(56, 189, 248, 0.18);
        border-color: rgba(56, 189, 248, 0.3);
      }
      .badge.b-fert {
        background: rgba(52, 211, 153, 0.18);
        border-color: rgba(52, 211, 153, 0.3);
      }
      .badge.b-comment {
        background: rgba(251, 191, 36, 0.18);
        border-color: rgba(251, 191, 36, 0.3);
      }

      .badge.comment-badge {
        cursor: pointer;
      }
      .badge.big-comment {
        font-size: 14px;
        padding: 6px 12px;
        transform: translateY(-1px);
      }

      dialog {
        width: min(860px, 92vw);
        border: 1px solid rgba(255, 255, 255, 0.22);
        border-radius: 22px;
        padding: 14px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.16),
          rgba(255, 255, 255, 0.1)
        );
        color: var(--text);
        backdrop-filter: blur(18px) saturate(140%);
        -webkit-backdrop-filter: blur(18px) saturate(140%);
        box-shadow: var(--shadow);
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
      }

      ul {
        margin: 8px 0 0;
        padding-left: 18px;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .plant-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 18px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        margin-top: 8px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
      }
      .plant-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .checklist {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .checkitem {
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 18px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
      }
      .checkitem input {
        width: 20px;
        height: 20px;
        accent-color: #22c55e;
      }

      .comment-item {
        margin-top: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 18px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
      }
      .comment-item.pinned {
        background: rgba(251, 191, 36, 0.16);
        border-color: rgba(251, 191, 36, 0.28);
      }

      .comment-header {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }
      .comment-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .comment-actions button {
        padding: 10px 12px;
        font-size: 14px;
      }
      .comment-text {
        margin-top: 8px;
        white-space: pre-wrap;
        color: rgba(236, 253, 245, 0.92);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.1);
        color: rgba(236, 253, 245, 0.9);
      }
      .pill input {
        width: 20px;
        height: 20px;
        accent-color: #fbbf24;
      }

      .status-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
      }
      .pill-mini {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.1);
        font-weight: 800;
        font-size: 13px;
        line-height: 1;
      }
      .pill-mini.water {
        background: rgba(56, 189, 248, 0.16);
        border-color: rgba(56, 189, 248, 0.28);
      }
      .pill-mini.fert {
        background: rgba(52, 211, 153, 0.16);
        border-color: rgba(52, 211, 153, 0.28);
      }
      .pill-mini.note {
        background: rgba(251, 191, 36, 0.16);
        border-color: rgba(251, 191, 36, 0.28);
      }
      .pill-mini.none {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.16);
        opacity: 0.9;
      }

      .mini-label {
        font-size: 13px;
        font-weight: 800;
        color: rgba(236, 253, 245, 0.82);
      }
    </style>
  </head>

  <body>
    <h1><span class="leaf">üåø</span> Pflanzenlog</h1>

    <div class="top-bar">
      <div class="row" style="margin-top: 0">
        <button class="btn-water" onclick="openAction('water')">
          üíß Gie√üen
        </button>
        <button class="btn-fert" onclick="openAction('fertilize')">
          üß™ D√ºngen
        </button>
        <button class="btn-note" onclick="openCommentToday()">
          üìù Kommentar (heute)
        </button>
        <button class="btn-ghost" onclick="openPlantOverview()">
          ü™¥ Pflanzen√ºbersicht
        </button>
      </div>
      <p id="output"></p>
    </div>

    <div class="card">
      <h2>Kalender</h2>

      <div class="row" style="justify-content: space-between; margin-top: 0">
        <button class="btn-ghost" onclick="prevMonth()">‚óÄ</button>
        <strong id="monthTitle"></strong>
        <button class="btn-ghost" onclick="nextMonth()">‚ñ∂</button>
      </div>

      <div id="calendar"></div>
    </div>

    <div class="bottom-bar">
      <div class="row" style="margin-top: 0; justify-content: space-between">
        <button class="btn-ghost" onclick="openHistory()">
          üìú Verlauf anzeigen
        </button>
        <button class="btn-ghost" onclick="openPlants()">
          ü™¥ Pflanzen verwalten
        </button>
      </div>
    </div>

    <!-- üìÖ Tagesansicht (Popup) -->
    <dialog id="dayViewDialog">
      <h2 id="dayViewTitle">üìÖ Tagesansicht</h2>

      <!-- ‚úÖ Schnell: f√ºr diesen Tag nachtragen -->
      <div class="row" style="margin-top: 6px">
        <button class="btn-water" onclick="openActionForSelectedDay('water')">
          üíß Gie√üen nachtragen
        </button>
        <button
          class="btn-fert"
          onclick="openActionForSelectedDay('fertilize')"
        >
          üß™ D√ºngen nachtragen
        </button>
      </div>

      <div id="dayViewBody"></div>

      <div class="comment-item" style="margin-top: 12px">
        <b>‚ûï Kommentar hinzuf√ºgen</b>

        <div class="row" style="margin-top: 8px">
          <select id="dayPopupCommentPlant" style="flex: 1"></select>
        </div>

        <textarea
          id="dayPopupCommentText"
          placeholder="Kommentar zu diesem Tag‚Ä¶"
        ></textarea>

        <div class="row" style="margin-top: 8px">
          <label class="pill">
            <input id="dayPopupCommentPinned" type="checkbox" />
            üìå anpinnen
          </label>
          <button class="btn-note" onclick="saveDayCommentFromPopup()">
            Speichern
          </button>
        </div>
      </div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closeDayView()">Schlie√üen</button>
      </div>
    </dialog>

    <!-- Verlauf -->
    <dialog id="historyDialog">
      <h2>Verlauf</h2>
      <ul id="history"></ul>

      <div class="row">
        <button class="btn-danger" onclick="clearAll()">
          üóëÔ∏è Alle Eintr√§ge l√∂schen
        </button>
        <button class="btn-ghost" onclick="closeHistory()">Schlie√üen</button>
      </div>
    </dialog>

    <!-- Pflanzen verwalten -->
    <dialog id="plantsDialog">
      <h2>Pflanzen verwalten</h2>

      <div class="row">
        <input
          id="newPlant"
          placeholder="Neue Pflanze (z. B. Ficus)"
          style="flex: 1"
        />

        <select id="newRoom" style="flex: 1">
          <option>Wohnzimmer</option>
          <option>Schlafzimmer</option>
          <option>Flur</option>
          <option>B√ºro</option>
        </select>

        <button class="btn-ghost" onclick="addPlant()">‚ûï Hinzuf√ºgen</button>
      </div>

      <div class="muted" style="margin-top: 8px">
        R√§ume f√ºr neue Pflanzen: Wohnzimmer, Schlafzimmer, Flur, B√ºro.
        <br />‚ÄûEntfernte Pflanzen‚Äú wird automatisch genutzt, wenn du Historie
        behalten willst.
      </div>

      <div id="plantsList" style="margin-top: 12px"></div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closePlants()">Schlie√üen</button>
      </div>
    </dialog>

    <!-- üè† Raum √§ndern -->
    <dialog id="roomDialog">
      <h2>üè† Raum √§ndern</h2>
      <p class="muted" id="roomPlantLabel"></p>

      <div class="row" style="margin-top: 6px">
        <select id="roomSelect" style="flex: 1"></select>
      </div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closeRoomDialog()">Abbrechen</button>
        <button class="btn-note" onclick="saveRoomDialog()">Speichern</button>
      </div>
    </dialog>

    <!-- Pflanze l√∂schen -->
    <dialog id="deletePlantDialog">
      <h2>Pflanze l√∂schen</h2>
      <p id="deletePlantText"></p>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="deletePlantCancel()">
          Abbrechen
        </button>
        <button class="btn-danger" onclick="deletePlantDeleteHistory()">
          Historie l√∂schen
        </button>
        <button class="btn-ghost" onclick="deletePlantKeepHistory()">
          Historie behalten
        </button>
      </div>
    </dialog>

    <!-- ‚úÖ Action Dialog (mit Datum) -->
    <dialog id="actionDialog">
      <h2 id="actionTitle"></h2>
      <p class="muted" id="actionHint"></p>

      <div class="comment-item" id="actionDateBlock" style="margin-top: 10px">
        <div class="mini-label">üìÖ Datum</div>
        <div class="row" style="margin-top: 8px">
          <input id="actionDate" type="date" style="flex: 1" />
          <button
            id="actionDateTodayBtn"
            class="btn-ghost"
            onclick="setActionDateToday()"
          >
            Heute
          </button>
        </div>

        <div class="muted" style="margin-top: 6px"></div>
      </div>

      <div class="row" style="margin-top: 10px">
        <button class="btn-ghost" onclick="selectAllPlants()">
          ‚úÖ Alle ausw√§hlen
        </button>
        <button class="btn-ghost" onclick="selectNonePlants()">
          üö´ Keine ausw√§hlen
        </button>
      </div>

      <div id="actionList" class="checklist"></div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="cancelAction()">Abbrechen</button>
        <button class="btn-note" onclick="confirmAction()">Speichern</button>
      </div>
    </dialog>

    <!-- Kommentar Dialog (HEUTE) -->
    <dialog id="commentDialog">
      <h2>üìù Kommentar (heute)</h2>

      <label for="commentPlant">Pflanze</label>
      <div class="row" style="margin-top: 6px">
        <select id="commentPlant" style="flex: 1"></select>
      </div>

      <label for="commentText" style="display: block; margin-top: 10px"
        >Kommentar</label
      >
      <textarea
        id="commentText"
        placeholder="z. B. Bl√§tter h√§ngen, Erde trocken..."
      ></textarea>

      <div class="row" style="margin-top: 8px">
        <label class="pill">
          <input id="commentPinned" type="checkbox" />
          üìå anpinnen
        </label>
      </div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closeComment()">Abbrechen</button>
        <button class="btn-note" onclick="saveCommentToday()">Speichern</button>
      </div>
    </dialog>

    <!-- üìù Popup pro Tag (klickbares Badge im Kalender) -->
    <dialog id="dayCommentsDialog">
      <h2 id="dayCommentsTitle"></h2>

      <div id="dayCommentsList"></div>

      <h3 style="margin-top: 12px">‚ûï Neuer Kommentar f√ºr diesen Tag</h3>

      <div class="row" style="margin-top: 6px">
        <select id="popupCommentPlant" style="flex: 1"></select>
      </div>

      <textarea id="popupCommentText" placeholder="Kommentar‚Ä¶"></textarea>

      <div class="row" style="margin-top: 8px">
        <label class="pill">
          <input id="popupCommentPinned" type="checkbox" />
          üìå anpinnen
        </label>
        <button class="btn-note" onclick="savePopupComment()">Speichern</button>
        <button class="btn-ghost" onclick="closeDayComments()">
          Schlie√üen
        </button>
      </div>
    </dialog>

    <!-- ü™¥ Pflanzen√ºbersicht -->
    <dialog id="plantOverviewDialog">
      <h2>ü™¥ Pflanzen√ºbersicht</h2>
      <div id="plantOverviewList"></div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closePlantOverview()">
          Schlie√üen
        </button>
      </div>
    </dialog>

    <!-- üìù Pflanzenkommentar (tagesunabh√§ngig) -->
    <dialog id="plantNoteDialog">
      <h2 id="plantNoteTitle">üìù Pflanzenkommentar</h2>

      <textarea
        id="plantNoteText"
        placeholder="Kommentar zur Pflanze (tagesunabh√§ngig)‚Ä¶"
      ></textarea>

      <div class="row" style="margin-top: 12px">
        <button class="btn-danger" onclick="clearPlantNote()">
          üóëÔ∏è L√∂schen
        </button>
        <button class="btn-ghost" onclick="closePlantNote()">Abbrechen</button>
        <button class="btn-note" onclick="savePlantNote()">Speichern</button>
      </div>
    </dialog>

    <script>
      // ==========================
      // STORAGE KEYS / SETTINGS
      // ==========================
      const STORAGE_KEY = "pflanzenlog_entries_v12";
      const PLANTS_KEY = "pflanzenlog_plants_v3_rooms_active";
      const PLANT_NOTES_KEY = "pflanzenlog_plant_notes_v1"; // { "Monstera": "Text..." }

      const ROOMS_BASE = ["Wohnzimmer", "Schlafzimmer", "Flur", "B√ºro"];
      const REMOVED_ROOM = "Entfernte Pflanzen";
      const ROOMS_ALL = [...ROOMS_BASE, REMOVED_ROOM];

      const state = {
        viewMonth: new Date(),
        selectedISO: isoDate(new Date()),
      };

      let pendingPlantToDelete = null;
      let pendingRoomPlant = null;
      let pendingPlantForNote = null;

      let pendingAction = null;
      let popupISO = null;

      // Action date (for backdating)
      let actionISO = isoDate(new Date());
      let actionDateLocked = false;

      // ==========================
      // HELPERS
      // ==========================
      function isoDate(d) {
        const x = new Date(d);
        const y = x.getFullYear();
        const m = String(x.getMonth() + 1).padStart(2, "0");
        const day = String(x.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function isoToNoonTs(iso) {
        const [y, m, d] = iso.split("-").map(Number);
        return new Date(y, m - 1, d, 12, 0, 0).getTime();
      }

      const uniq = (arr) => Array.from(new Set((arr || []).filter(Boolean)));
      const setUnion = (a, b) => uniq([...(a || []), ...(b || [])]);

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function uuid() {
        const now = Date.now();
        return crypto?.randomUUID
          ? crypto.randomUUID()
          : String(now) + "_" + Math.random().toString(16).slice(2);
      }

      function openDialog(id) {
        const dlg = document.getElementById(id);
        if (!dlg) return;
        if (dlg.showModal) dlg.showModal();
        else dlg.setAttribute("open", "");
      }

      function closeDialog(id) {
        const dlg = document.getElementById(id);
        if (!dlg) return;
        if (dlg.close) dlg.close();
        else dlg.removeAttribute("open");
      }

      function out(msg) {
        const el = document.getElementById("output");
        if (el) el.textContent = msg || "";
      }

      // ==========================
      // STORAGE LOAD/SAVE
      // ==========================
      function loadEntries() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch {
          return [];
        }
      }

      function saveEntries(entries) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries || []));
      }

      function normalizePlant(p) {
        const name = String(p?.name || "").trim();
        if (!name) return null;
        const roomRaw = String(p?.room || "Wohnzimmer").trim();
        const room = ROOMS_ALL.includes(roomRaw) ? roomRaw : "Wohnzimmer";
        const active = p?.active === false ? false : true;
        return { name, room, active };
      }

      function migrateOldPlantsIfNeeded() {
        // v2 -> v3
        try {
          const v2 = JSON.parse(
            localStorage.getItem("pflanzenlog_plants_v2_rooms")
          );
          if (Array.isArray(v2) && v2.length) {
            const migrated = v2
              .map((x) => normalizePlant({ ...x, active: true }))
              .filter(Boolean);
            localStorage.setItem(PLANTS_KEY, JSON.stringify(migrated));
            return migrated;
          }
        } catch {}

        // v1 -> v3
        try {
          const v1 = JSON.parse(localStorage.getItem("pflanzenlog_plants_v1"));
          if (Array.isArray(v1) && v1.length) {
            const migrated =
              typeof v1[0] === "string"
                ? v1
                    .map((name) =>
                      normalizePlant({ name, room: "Wohnzimmer", active: true })
                    )
                    .filter(Boolean)
                : v1
                    .map((x) =>
                      normalizePlant({
                        name: x.name,
                        room: "Wohnzimmer",
                        active: true,
                      })
                    )
                    .filter(Boolean);

            localStorage.setItem(PLANTS_KEY, JSON.stringify(migrated));
            return migrated;
          }
        } catch {}

        // Defaults (damit nicht "alles leer" ist)
        const defaults = [
          { name: "Monstera", room: "Wohnzimmer", active: true },
          { name: "Orchidee", room: "Schlafzimmer", active: true },
          { name: "Calathea", room: "B√ºro", active: true },
          { name: "Pothos", room: "Flur", active: true },
        ]
          .map(normalizePlant)
          .filter(Boolean);

        localStorage.setItem(PLANTS_KEY, JSON.stringify(defaults));
        return defaults;
      }

      function loadPlants() {
        try {
          const v3 = JSON.parse(localStorage.getItem(PLANTS_KEY));
          if (Array.isArray(v3) && v3.length)
            return v3.map(normalizePlant).filter(Boolean);
        } catch {}
        return migrateOldPlantsIfNeeded();
      }

      function savePlants(plants) {
        localStorage.setItem(
          PLANTS_KEY,
          JSON.stringify((plants || []).map(normalizePlant).filter(Boolean))
        );
      }

      function loadPlantNotes() {
        try {
          return JSON.parse(localStorage.getItem(PLANT_NOTES_KEY)) || {};
        } catch {
          return {};
        }
      }

      function savePlantNotes(map) {
        localStorage.setItem(PLANT_NOTES_KEY, JSON.stringify(map || {}));
      }

      function getPlantNote(name) {
        const notes = loadPlantNotes();
        return String(notes?.[name] || "").trim();
      }

      function setPlantNote(name, text) {
        const notes = loadPlantNotes();
        const cleaned = String(text || "").trim();
        if (!cleaned) delete notes[name];
        else notes[name] = cleaned;
        savePlantNotes(notes);
      }

      function getAllPlants() {
        return loadPlants();
      }

      function getActivePlants() {
        return loadPlants().filter(
          (p) => p.active !== false && p.room !== REMOVED_ROOM
        );
      }

      function activePlantNames() {
        return getActivePlants().map((p) => p.name);
      }

      function groupPlantsByRoom(plants) {
        const map = new Map();
        plants.forEach((p) => {
          const room = ROOMS_ALL.includes(p.room) ? p.room : "Wohnzimmer";
          if (!map.has(room)) map.set(room, []);
          map.get(room).push(p);
        });
        return ROOMS_ALL.map((r) => [
          r,
          (map.get(r) || []).sort((a, b) => a.name.localeCompare(b.name, "de")),
        ]);
      }

      // ==========================
      // AGGREGATION
      // ==========================
      function aggregateDay(entries, iso) {
        const res = {
          water: { snapshot: [], done: [] },
          fertilize: { snapshot: [], done: [] },
          comments: [],
        };

        const dayEntries = (entries || []).filter(
          (e) => e && isoDate(e.ts) === iso
        );

        dayEntries.forEach((e) => {
          if (e.type === "batch") {
            if (e.action === "water") {
              res.water.snapshot = setUnion(res.water.snapshot, e.snapshot);
              res.water.done = setUnion(res.water.done, e.done);
            }
            if (e.action === "fertilize") {
              res.fertilize.snapshot = setUnion(
                res.fertilize.snapshot,
                e.snapshot
              );
              res.fertilize.done = setUnion(res.fertilize.done, e.done);
            }
          } else if (e.type === "comment") {
            res.comments.push({
              id: e.id,
              plant: e.plant || "Unbekannt",
              text: e.text || "",
              ts: e.ts,
              pinned: !!e.pinned,
            });
          }
        });

        res.water.snapshot = uniq(res.water.snapshot);
        res.water.done = uniq(res.water.done);
        res.fertilize.snapshot = uniq(res.fertilize.snapshot);
        res.fertilize.done = uniq(res.fertilize.done);

        res.comments.sort((a, b) => b.pinned - a.pinned || b.ts - a.ts);
        return res;
      }

      function buildCounts(entries) {
        const map = new Map();
        const days = uniq((entries || []).map((e) => isoDate(e.ts)));

        days.forEach((iso) => {
          const agg = aggregateDay(entries, iso);
          map.set(iso, {
            hasAny:
              (agg.water.done?.length || 0) > 0 ||
              (agg.fertilize.done?.length || 0) > 0 ||
              (agg.comments?.length || 0) > 0,
            waterDone: new Set(agg.water.done || []),
            fertDone: new Set(agg.fertilize.done || []),
            commentsCount: agg.comments.length || 0,
          });
        });

        return map;
      }

      // ==========================
      // PLANTS DIALOG (MANAGE)
      // ==========================
      function renderPlants() {
        const plants = getAllPlants();
        const list = document.getElementById("plantsList");
        if (!list) return;
        list.innerHTML = "";

        const grouped = groupPlantsByRoom(plants);

        grouped.forEach(([room, ps]) => {
          if (!ps.length) return;

          const header = document.createElement("div");
          header.className = "comment-item";
          header.innerHTML =
            `<b>üè† ${escapeHtml(room)}</b>` +
            (room === REMOVED_ROOM
              ? `<div class="muted" style="margin-top:6px;">Diese Pflanzen bleiben f√ºr die Historie sichtbar.</div>`
              : "");
          list.appendChild(header);

          ps.forEach((pObj) => {
            const row = document.createElement("div");
            row.className = "plant-row";

            const left = document.createElement("div");
            const inactiveHint =
              pObj.active === false || pObj.room === REMOVED_ROOM
                ? " (entfernt)"
                : "";
            left.innerHTML = `<b>${escapeHtml(
              pObj.name
            )}${inactiveHint}</b><div class="muted">üè† ${escapeHtml(
              pObj.room
            )}</div>`;

            const actions = document.createElement("div");
            actions.className = "plant-actions";

            const renameBtn = document.createElement("button");
            renameBtn.className = "btn-ghost";
            renameBtn.textContent = "‚úèÔ∏è";
            renameBtn.onclick = () => renamePlant(pObj.name);

            const roomBtn = document.createElement("button");
            roomBtn.className = "btn-ghost";
            roomBtn.textContent = "üè†";
            roomBtn.onclick = () => openRoomDialog(pObj.name);

            const noteBtn = document.createElement("button");
            noteBtn.className = "btn-ghost";
            noteBtn.textContent = "üìù";
            noteBtn.onclick = () => openPlantNote(pObj.name);

            const delBtn = document.createElement("button");
            delBtn.className = "btn-danger";
            delBtn.textContent = "üóëÔ∏è";
            delBtn.onclick = () => removePlant(pObj.name);

            actions.appendChild(noteBtn);
            actions.appendChild(roomBtn);
            actions.appendChild(renameBtn);
            actions.appendChild(delBtn);

            row.appendChild(left);
            row.appendChild(actions);
            list.appendChild(row);
          });
        });
      }

      function openPlants() {
        renderPlants();
        openDialog("plantsDialog");
      }

      function closePlants() {
        closeDialog("plantsDialog");
      }

      function addPlant() {
        const inp = document.getElementById("newPlant");
        const roomSel = document.getElementById("newRoom");

        const name = (inp?.value || "").trim();
        const room = (roomSel?.value || "Wohnzimmer").trim();
        if (!name) return;

        const plants = getAllPlants();
        if (plants.some((p) => p.name.toLowerCase() === name.toLowerCase())) {
          out("Diese Pflanze gibt‚Äôs schon üôÇ");
          return;
        }

        plants.unshift({
          name,
          room: ROOMS_BASE.includes(room) ? room : "Wohnzimmer",
          active: true,
        });
        savePlants(plants);

        if (inp) inp.value = "";
        if (roomSel) roomSel.value = "Wohnzimmer";

        out(`‚úÖ Pflanze hinzugef√ºgt: ${name} (${room})`);
        renderAll();
      }

      function renamePlant(oldName) {
        const newName = prompt(`Neuer Name f√ºr ‚Äû${oldName}‚Äú:`, oldName);
        if (newName === null) return;
        const cleaned = newName.trim();
        if (!cleaned) return;

        const plants = getAllPlants();
        if (
          plants.some(
            (p) =>
              p.name.toLowerCase() === cleaned.toLowerCase() &&
              p.name !== oldName
          )
        ) {
          out("Name existiert schon üôÇ");
          return;
        }

        savePlants(
          plants.map((p) => (p.name === oldName ? { ...p, name: cleaned } : p))
        );

        // Entries mit umbenennen
        const entries = loadEntries().map((e) =>
          renamePlantInEntry(e, oldName, cleaned)
        );
        saveEntries(entries);

        // Plant notes umbenennen
        const notes = loadPlantNotes();
        if (notes[oldName]) {
          notes[cleaned] = notes[oldName];
          delete notes[oldName];
          savePlantNotes(notes);
        }

        out(`‚úÖ Umbenannt: ${oldName} ‚Üí ${cleaned}`);
        renderAll();
      }

      function renamePlantInEntry(e, oldName, newName) {
        if (!e) return e;

        if (e.type === "batch") {
          const repl = (arr) =>
            Array.isArray(arr)
              ? arr.map((x) => (x === oldName ? newName : x))
              : arr;
          return { ...e, snapshot: repl(e.snapshot), done: repl(e.done) };
        }
        if (e.type === "comment") {
          if (e.plant === oldName) return { ...e, plant: newName };
          return e;
        }
        return e;
      }

      // ==========================
      // ROOM DIALOG
      // ==========================
      function openRoomDialog(name) {
        pendingRoomPlant = name;
        const plants = getAllPlants();
        const current = plants.find((p) => p.name === name);

        const label = document.getElementById("roomPlantLabel");
        if (label) label.textContent = `Pflanze: ${name}`;

        const sel = document.getElementById("roomSelect");
        if (!sel) return;

        sel.innerHTML = "";
        ROOMS_ALL.forEach((r) => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          sel.appendChild(opt);
        });

        sel.value = ROOMS_ALL.includes(current?.room)
          ? current.room
          : "Wohnzimmer";

        openDialog("roomDialog");
      }

      function closeRoomDialog() {
        pendingRoomPlant = null;
        closeDialog("roomDialog");
      }

      function saveRoomDialog() {
        if (!pendingRoomPlant) return;
        const room = document.getElementById("roomSelect")?.value;

        const plants = getAllPlants();
        savePlants(
          plants.map((p) => {
            if (p.name !== pendingRoomPlant) return p;
            const nextRoom = ROOMS_ALL.includes(room) ? room : "Wohnzimmer";
            const nextActive = nextRoom === REMOVED_ROOM ? false : true;
            return { ...p, room: nextRoom, active: nextActive };
          })
        );

        out(`üè† Raum gesetzt: ${pendingRoomPlant} ‚Üí ${room}`);
        closeRoomDialog();
        renderAll();
      }

      // ==========================
      // DELETE PLANT DIALOG
      // ==========================
      function removePlant(name) {
        const plants = getAllPlants();
        const activeCount = getActivePlants().length;
        const target = plants.find((p) => p.name === name);
        const isActive =
          target && target.active !== false && target.room !== REMOVED_ROOM;
        if (isActive && activeCount <= 1) {
          out("Mindestens 1 aktive Pflanze behalten üôÇ");
          return;
        }
        pendingPlantToDelete = name;
        openDeletePlantDialog(name);
      }

      function openDeletePlantDialog(plantName) {
        const t = document.getElementById("deletePlantText");
        if (t)
          t.textContent = `Was soll mit der Historie von ‚Äû${plantName}‚Äú passieren?`;
        openDialog("deletePlantDialog");
      }

      function closeDeletePlantDialog() {
        closeDialog("deletePlantDialog");
      }

      function deletePlantCancel() {
        pendingPlantToDelete = null;
        closeDeletePlantDialog();
        out("Abgebrochen ‚Äì nichts ge√§ndert.");
      }

      function deletePlantKeepHistory() {
        if (!pendingPlantToDelete) return;
        const name = pendingPlantToDelete;

        const plants = getAllPlants();
        savePlants(
          plants.map((p) =>
            p.name !== name ? p : { ...p, room: REMOVED_ROOM, active: false }
          )
        );

        pendingPlantToDelete = null;
        closeDeletePlantDialog();
        out(
          `‚úÖ ‚Äû${name}‚Äú wurde zu ‚Äû${REMOVED_ROOM}‚Äú verschoben (Historie bleibt).`
        );
        renderAll();
      }

      function removePlantFromEntry(e, name) {
        if (!e) return e;

        if (e.type === "batch") {
          const filt = (arr) =>
            Array.isArray(arr) ? arr.filter((x) => x !== name) : arr;
          const next = { ...e, snapshot: filt(e.snapshot), done: filt(e.done) };
          const doneLen = Array.isArray(next.done) ? next.done.length : 0;
          if (doneLen === 0) return null;
          return next;
        }
        if (e.type === "comment") return e.plant === name ? null : e;
        return e;
      }

      function deletePlantDeleteHistory() {
        if (!pendingPlantToDelete) return;
        const name = pendingPlantToDelete;

        savePlants(getAllPlants().filter((p) => p.name !== name));

        const entries = loadEntries();
        const cleaned = entries
          .map((e) => removePlantFromEntry(e, name))
          .filter((e) => e !== null);
        saveEntries(cleaned);

        setPlantNote(name, "");

        pendingPlantToDelete = null;
        closeDeletePlantDialog();
        out(`üóëÔ∏è Pflanze + Historie gel√∂scht: ${name}`);
        renderAll();
      }

      // ==========================
      // PLANT NOTE (per plant)
      // ==========================
      function openPlantNote(name) {
        pendingPlantForNote = name;
        const title = document.getElementById("plantNoteTitle");
        const ta = document.getElementById("plantNoteText");
        if (title) title.textContent = `üìù Pflanzenkommentar ‚Äì ${name}`;
        if (ta) ta.value = getPlantNote(name);
        openDialog("plantNoteDialog");
      }

      function closePlantNote() {
        pendingPlantForNote = null;
        closeDialog("plantNoteDialog");
      }

      function savePlantNote() {
        if (!pendingPlantForNote) return;
        const text = document.getElementById("plantNoteText")?.value || "";
        setPlantNote(pendingPlantForNote, text);
        out("üìù Pflanzenkommentar gespeichert ‚úÖ");
        closePlantNote();
        renderAll();
      }

      function clearPlantNote() {
        if (!pendingPlantForNote) return;
        setPlantNote(pendingPlantForNote, "");
        const ta = document.getElementById("plantNoteText");
        if (ta) ta.value = "";
        out("üóëÔ∏è Pflanzenkommentar gel√∂scht.");
        renderAll();
      }

      // ==========================
      // PLANT OVERVIEW
      // ==========================
      function openPlantOverview() {
        renderPlantOverview();
        openDialog("plantOverviewDialog");
      }
      function closePlantOverview() {
        closeDialog("plantOverviewDialog");
      }

      function renderPlantOverview() {
        const wrap = document.getElementById("plantOverviewList");
        if (!wrap) return;
        wrap.innerHTML = "";

        const plants = getAllPlants();
        const grouped = groupPlantsByRoom(plants);

        grouped.forEach(([room, ps]) => {
          if (!ps.length) return;

          const card = document.createElement("div");
          card.className = "comment-item";
          card.innerHTML = `<b>üè† ${escapeHtml(room)}</b>`;

          ps.forEach((p) => {
            const note = getPlantNote(p.name);
            const line = document.createElement("div");
            line.style.marginTop = "10px";
            line.innerHTML =
              `ü™¥ <b>${escapeHtml(p.name)}</b>` +
              (note
                ? `<div class="muted" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(
                    note
                  )}</div>`
                : `<div class="muted" style="margin-top:6px;">(kein Pflanzenkommentar)</div>`);
            card.appendChild(line);
          });

          wrap.appendChild(card);
        });
      }

      // ==========================
      // HISTORY DIALOG
      // ==========================
      function renderHistory(entries) {
        const historyEl = document.getElementById("history");
        if (!historyEl) return;
        historyEl.innerHTML = "";

        if (!(entries || []).length) {
          const li = document.createElement("li");
          li.textContent = "Noch keine Eintr√§ge.";
          historyEl.appendChild(li);
          return;
        }

        const days = uniq(entries.map((e) => isoDate(e.ts))).sort((a, b) =>
          a < b ? 1 : -1
        );
        const total = getActivePlants().length;

        days.forEach((iso) => {
          const agg = aggregateDay(entries, iso);
          const parts = [];
          parts.push(`üåø${total}`);
          if (agg.water.done.length) parts.push(`üíß${agg.water.done.length}`);
          if (agg.fertilize.done.length)
            parts.push(`üß™${agg.fertilize.done.length}`);
          if (agg.comments.length) parts.push(`üìù${agg.comments.length}`);

          const li = document.createElement("li");
          li.textContent = `${iso}: ${parts.join("  ‚Ä¢  ")}`;
          historyEl.appendChild(li);
        });
      }

      function openHistory() {
        renderAll();
        openDialog("historyDialog");
      }

      function closeHistory() {
        closeDialog("historyDialog");
      }

      // ==========================
      // ACTION DIALOG (water/fertilize) + backdating
      // ==========================
      function setActionDateToday() {
        const today = isoDate(new Date());
        const dateEl = document.getElementById("actionDate");
        if (dateEl) dateEl.value = today;
        actionISO = today;
        refreshActionListForDate();
      }

      function openActionWithDate(action, iso, lockDate = false) {
        pendingAction = action;

        const title = document.getElementById("actionTitle");
        if (title) {
          title.textContent =
            action === "water"
              ? "üíß Gie√üen ‚Äì welche Pflanzen?"
              : "üß™ D√ºngen ‚Äì welche Pflanzen?";
        }

        actionISO = iso || isoDate(new Date());
        actionDateLocked = !!lockDate;

        const dateEl = document.getElementById("actionDate");
        if (dateEl) {
          dateEl.value = actionISO;
          dateEl.disabled = actionDateLocked;

          dateEl.onchange = () => {
            if (actionDateLocked) {
              dateEl.value = actionISO;
              return;
            }
            actionISO = dateEl.value || isoDate(new Date());
            refreshActionListForDate();
          };
        }

        const todayBtn = document.getElementById("actionDateTodayBtn");
        if (todayBtn) todayBtn.style.display = actionDateLocked ? "none" : "";

        refreshActionListForDate();
        openDialog("actionDialog");
      }

      function openAction(action) {
        // Top-bar actions: standardm√§√üig "heute" und Datum gesperrt
        openActionWithDate(action, isoDate(new Date()), true);
      }

      function openActionForSelectedDay(action) {
        openActionWithDate(action, state.selectedISO, true);
      }

      function refreshActionListForDate() {
        const entries = loadEntries();
        const agg = aggregateDay(entries, actionISO);
        const alreadyDone =
          pendingAction === "water" ? agg.water.done : agg.fertilize.done;

        const hint = document.getElementById("actionHint");
        if (hint) {
          hint.textContent = alreadyDone.length
            ? `Smart-Default: an diesem Datum schon geloggt (${alreadyDone.length}) ist abgew√§hlt.`
            : "Smart-Default: alle Pflanzen sind ausgew√§hlt.";
        }

        const list = document.getElementById("actionList");
        if (!list) return;
        list.innerHTML = "";

        const plants = getActivePlants();
        plants.forEach((pObj, idx) => {
          const row = document.createElement("label");
          row.className = "checkitem";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.dataset.plant = pObj.name;
          cb.id = "cb_" + idx;
          cb.checked = !alreadyDone.includes(pObj.name);

          const text = document.createElement("span");
          text.textContent = `${pObj.name} (${pObj.room || "Wohnzimmer"})`;

          row.appendChild(cb);
          row.appendChild(text);
          list.appendChild(row);
        });
      }

      function selectAllPlants() {
        document
          .querySelectorAll("#actionList input[type=checkbox]")
          .forEach((cb) => (cb.checked = true));
      }

      function selectNonePlants() {
        document
          .querySelectorAll("#actionList input[type=checkbox]")
          .forEach((cb) => (cb.checked = false));
      }

      function cancelAction() {
        pendingAction = null;
        closeDialog("actionDialog");
        out("Abgebrochen ‚Äì nichts gespeichert.");
      }

      function confirmAction() {
        if (!pendingAction) return;

        const selected = Array.from(
          document.querySelectorAll("#actionList input[type=checkbox]")
        )
          .filter((cb) => cb.checked)
          .map((cb) => cb.dataset.plant);

        if (selected.length === 0) {
          out("Keine Pflanzen ausgew√§hlt üôÇ");
          return;
        }

        const iso = actionISO || isoDate(new Date());
        const ts = isoToNoonTs(iso);
        const dateStr = new Date(ts).toLocaleDateString("de-DE");

        const entries = loadEntries();
        const idx = entries.findIndex(
          (e) =>
            e &&
            e.type === "batch" &&
            e.action === pendingAction &&
            isoDate(e.ts) === iso
        );

        const snapshot = activePlantNames();

        if (idx >= 0) {
          const existing = entries[idx];
          entries[idx] = {
            ...existing,
            ts,
            date: dateStr,
            snapshot: setUnion(existing.snapshot, snapshot),
            done: setUnion(existing.done, selected),
          };
        } else {
          entries.unshift({
            type: "batch",
            action: pendingAction,
            ts,
            date: dateStr,
            snapshot: uniq(snapshot),
            done: uniq(selected),
          });
        }

        saveEntries(entries);

        out(
          `${pendingAction === "water" ? "üíß" : "üß™"} gespeichert f√ºr ${iso
            .split("-")
            .reverse()
            .join(".")}: ${selected.length} Pflanze(n) ‚úÖ`
        );

        state.selectedISO = iso;
        pendingAction = null;
        closeDialog("actionDialog");
        renderAll();
      }

      // ==========================
      // COMMENTS (today + per day popup)
      // ==========================
      function fillCommentPlants(selectElId, includeRemoved = true) {
        const plants = includeRemoved ? getAllPlants() : getActivePlants();
        const sel = document.getElementById(selectElId);
        if (!sel) return;
        sel.innerHTML = "";
        plants.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.name;
          const removedTag =
            p.room === REMOVED_ROOM || p.active === false ? " ‚Ä¢ entfernt" : "";
          opt.textContent = `${p.name} (${p.room})${removedTag}`;
          sel.appendChild(opt);
        });
      }

      function saveCommentForISO(iso, plant, text, pinned) {
        const ts = isoToNoonTs(iso);
        const entry = {
          type: "comment",
          id: uuid(),
          ts,
          date: new Date(ts).toLocaleDateString("de-DE"),
          plant,
          text,
          pinned: !!pinned,
        };
        const entries = loadEntries();
        entries.unshift(entry);
        saveEntries(entries);
      }

      function openCommentToday() {
        fillCommentPlants("commentPlant", true);
        const ta = document.getElementById("commentText");
        const pin = document.getElementById("commentPinned");
        if (ta) ta.value = "";
        if (pin) pin.checked = false;
        openDialog("commentDialog");
      }

      function closeComment() {
        closeDialog("commentDialog");
      }

      function saveCommentToday() {
        const plant = (
          document.getElementById("commentPlant")?.value || ""
        ).trim();
        const text = (
          document.getElementById("commentText")?.value || ""
        ).trim();
        const pinned = !!document.getElementById("commentPinned")?.checked;

        if (!plant) return out("Bitte eine Pflanze ausw√§hlen üôÇ");
        if (!text) return out("Bitte einen Kommentar eingeben üôÇ");

        const iso = isoDate(new Date());
        saveCommentForISO(iso, plant, text, pinned);

        state.selectedISO = iso;
        out("üìù Kommentar gespeichert ‚úÖ");
        closeComment();
        renderAll();
      }

      // ==========================
      // DAY COMMENTS POPUP (badge)
      // ==========================
      function openDayCommentsFromBadge(evt, iso) {
        if (evt) evt.stopPropagation();
        openDayComments(iso);
      }

      function openDayComments(iso) {
        popupISO = iso;

        const title = document.getElementById("dayCommentsTitle");
        if (title)
          title.textContent = `üìù Kommentare ‚Äì ${iso
            .split("-")
            .reverse()
            .join(".")}`;

        fillCommentPlants("popupCommentPlant", true);

        const ta = document.getElementById("popupCommentText");
        const pin = document.getElementById("popupCommentPinned");
        if (ta) ta.value = "";
        if (pin) pin.checked = false;

        renderDayCommentsPopup();
        openDialog("dayCommentsDialog");
      }

      function closeDayComments() {
        popupISO = null;
        closeDialog("dayCommentsDialog");
      }

      function renderDayCommentsPopup() {
        const wrap = document.getElementById("dayCommentsList");
        if (!wrap) return;
        wrap.innerHTML = "";
        if (!popupISO) return;

        const entries = loadEntries();
        const agg = aggregateDay(entries, popupISO);

        if (!agg.comments.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "Noch keine Kommentare an diesem Tag.";
          wrap.appendChild(p);
          return;
        }

        agg.comments.forEach((c) => {
          const box = document.createElement("div");
          box.className = "comment-item" + (c.pinned ? " pinned" : "");

          const header = document.createElement("div");
          header.className = "comment-header";

          const left = document.createElement("div");
          left.innerHTML = `ü™¥ <b>${escapeHtml(c.plant)}</b> ${
            c.pinned ? " <span class='pill'>üìå</span>" : ""
          }`;

          const actions = document.createElement("div");
          actions.className = "comment-actions";

          const pinBtn = document.createElement("button");
          pinBtn.className = "btn-ghost";
          pinBtn.textContent = c.pinned ? "üìå‚úì" : "üìå";
          pinBtn.onclick = () => togglePinComment(c.id);

          const editBtn = document.createElement("button");
          editBtn.className = "btn-ghost";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.onclick = () => editComment(c.id);

          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger";
          delBtn.textContent = "üóëÔ∏è";
          delBtn.onclick = () => deleteComment(c.id);

          actions.appendChild(pinBtn);
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          header.appendChild(left);
          header.appendChild(actions);

          const text = document.createElement("div");
          text.className = "comment-text";
          text.textContent = c.text;

          box.appendChild(header);
          box.appendChild(text);
          wrap.appendChild(box);
        });
      }

      function savePopupComment() {
        if (!popupISO) return;

        const plant = (
          document.getElementById("popupCommentPlant")?.value || ""
        ).trim();
        const text = (
          document.getElementById("popupCommentText")?.value || ""
        ).trim();
        const pinned = !!document.getElementById("popupCommentPinned")?.checked;

        if (!plant) return out("Bitte eine Pflanze ausw√§hlen üôÇ");
        if (!text) return out("Bitte einen Kommentar eingeben üôÇ");

        saveCommentForISO(popupISO, plant, text, pinned);

        const ta = document.getElementById("popupCommentText");
        const pin = document.getElementById("popupCommentPinned");
        if (ta) ta.value = "";
        if (pin) pin.checked = false;

        out("üìù Kommentar gespeichert ‚úÖ");
        renderAll();
        renderDayCommentsPopup();
        renderDayViewPopup();
      }

      function editComment(id) {
        const entries = loadEntries();
        const idx = entries.findIndex(
          (e) => e && e.type === "comment" && e.id === id
        );
        if (idx < 0) return;

        const current = entries[idx];
        const newText = prompt(
          `Kommentar f√ºr ${current.plant} bearbeiten:`,
          current.text || ""
        );
        if (newText === null) return;

        const cleaned = String(newText).trim();
        if (!cleaned) return alert("Kommentar darf nicht leer sein.");

        entries[idx] = { ...current, text: cleaned };
        saveEntries(entries);

        out("üìù Kommentar aktualisiert ‚úÖ");
        renderAll();
        if (popupISO) renderDayCommentsPopup();
        renderDayViewPopup();
      }

      function deleteComment(id) {
        if (!confirm("Kommentar wirklich l√∂schen?")) return;
        const entries = loadEntries().filter(
          (e) => !(e && e.type === "comment" && e.id === id)
        );
        saveEntries(entries);
        out("üóëÔ∏è Kommentar gel√∂scht.");
        renderAll();
        if (popupISO) renderDayCommentsPopup();
        renderDayViewPopup();
      }

      function togglePinComment(id) {
        const entries = loadEntries();
        const idx = entries.findIndex(
          (e) => e && e.type === "comment" && e.id === id
        );
        if (idx < 0) return;
        entries[idx] = { ...entries[idx], pinned: !entries[idx].pinned };
        saveEntries(entries);
        renderAll();
        if (popupISO) renderDayCommentsPopup();
        renderDayViewPopup();
      }

      // ==========================
      // DAY VIEW DIALOG
      // ==========================
      function openDayView(iso) {
        state.selectedISO = iso;
        const title = document.getElementById("dayViewTitle");
        if (title)
          title.textContent = `üìÖ Tagesansicht ‚Äì ${iso
            .split("-")
            .reverse()
            .join(".")}`;

        fillCommentPlants("dayPopupCommentPlant", true);

        const ta = document.getElementById("dayPopupCommentText");
        const pin = document.getElementById("dayPopupCommentPinned");
        if (ta) ta.value = "";
        if (pin) pin.checked = false;

        renderDayViewPopup();
        openDialog("dayViewDialog");
      }

      function closeDayView() {
        closeDialog("dayViewDialog");
      }

      function pillMini(text, cls) {
        return `<span class="pill-mini ${cls}">${text}</span>`;
      }

      function renderDayViewPopup() {
        const body = document.getElementById("dayViewBody");
        if (!body) return;
        body.innerHTML = "";

        const entries = loadEntries();
        const iso = state.selectedISO;
        const agg = aggregateDay(entries, iso);

        const waterDone = new Set(agg.water.done || []);
        const fertDone = new Set(agg.fertilize.done || []);

        const commentsByPlant = new Map();
        (agg.comments || []).forEach((c) => {
          const k = c.plant || "Unbekannt";
          commentsByPlant.set(k, (commentsByPlant.get(k) || 0) + 1);
        });

        function statusPillsFor(name) {
          const pills = [];
          if (waterDone.has(name)) pills.push(pillMini("üíß", "water"));
          if (fertDone.has(name)) pills.push(pillMini("üß™", "fert"));
          const cc = commentsByPlant.get(name) || 0;
          if (cc) pills.push(pillMini(`üìù${cc}`, "note"));
          if (!waterDone.has(name) && !fertDone.has(name))
            pills.unshift(pillMini("‚Äî", "none"));
          return pills.join("");
        }

        const all = getAllPlants();
        const active = all.filter(
          (p) => p.active !== false && p.room !== REMOVED_ROOM
        );
        const removed = all.filter(
          (p) => p.room === REMOVED_ROOM || p.active === false
        );

        const activeGrouped = groupPlantsByRoom(active);
        activeGrouped.forEach(([room, ps]) => {
          if (room === REMOVED_ROOM) return;
          if (!ps.length) return;

          const roomCard = document.createElement("div");
          roomCard.className = "comment-item";
          roomCard.innerHTML = `<b>üè† ${escapeHtml(room)}</b>`;

          ps.forEach((p) => {
            const line = document.createElement("div");
            line.style.marginTop = "10px";
            line.innerHTML = `ü™¥ <b>${escapeHtml(
              p.name
            )}</b><div class="status-pills">${statusPillsFor(p.name)}</div>`;
            roomCard.appendChild(line);
          });

          body.appendChild(roomCard);
        });

        // Entfernte Pflanzen nur wenn an dem Tag relevant
        const relevantNames = new Set(
          [
            ...(agg.water.snapshot || []),
            ...(agg.fertilize.snapshot || []),
            ...(agg.water.done || []),
            ...(agg.fertilize.done || []),
            ...(agg.comments || []).map((c) => c.plant),
          ].filter(Boolean)
        );

        const removedRelevant = removed
          .filter((p) => relevantNames.has(p.name))
          .sort((a, b) => a.name.localeCompare(b.name, "de"));

        if (removedRelevant.length) {
          const roomCard = document.createElement("div");
          roomCard.className = "comment-item";
          roomCard.innerHTML = `<b>üèöÔ∏è ${escapeHtml(REMOVED_ROOM)}</b>
        <div class="muted" style="margin-top:6px;">Diese Pflanzen wurden entfernt, werden aber f√ºr die Historie angezeigt.</div>`;

          removedRelevant.forEach((p) => {
            const line = document.createElement("div");
            line.style.marginTop = "10px";
            line.innerHTML = `ü™¥ <b>${escapeHtml(
              p.name
            )}</b><div class="status-pills">${statusPillsFor(p.name)}</div>`;
            roomCard.appendChild(line);
          });

          body.appendChild(roomCard);
        }

        // Kommentare
        const comments = agg.comments || [];
        const commentsCard = document.createElement("div");
        commentsCard.className = "comment-item";
        commentsCard.innerHTML = "<b>üìù Kommentare</b>";

        if (!comments.length) {
          const p = document.createElement("div");
          p.className = "muted";
          p.style.marginTop = "8px";
          p.textContent = "Keine Kommentare an diesem Tag.";
          commentsCard.appendChild(p);
        } else {
          comments.forEach((c) => {
            const item = document.createElement("div");
            item.style.marginTop = "10px";
            item.innerHTML =
              `ü™¥ <b>${escapeHtml(c.plant)}</b>${
                c.pinned ? " <span class='pill'>üìå</span>" : ""
              }` +
              `<div class="muted" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(
                c.text
              )}</div>`;
            commentsCard.appendChild(item);
          });
        }

        body.appendChild(commentsCard);
      }

      function saveDayCommentFromPopup() {
        const plant = (
          document.getElementById("dayPopupCommentPlant")?.value || ""
        ).trim();
        const text = (
          document.getElementById("dayPopupCommentText")?.value || ""
        ).trim();
        const pinned = !!document.getElementById("dayPopupCommentPinned")
          ?.checked;

        if (!plant) return out("Bitte eine Pflanze ausw√§hlen üôÇ");
        if (!text) return out("Bitte einen Kommentar eingeben üôÇ");

        const iso = state.selectedISO;
        saveCommentForISO(iso, plant, text, pinned);

        const ta = document.getElementById("dayPopupCommentText");
        const pin = document.getElementById("dayPopupCommentPinned");
        if (ta) ta.value = "";
        if (pin) pin.checked = false;

        out("üìù Kommentar zum Tag gespeichert ‚úÖ");
        renderAll();
        if (popupISO) renderDayCommentsPopup();
        renderDayViewPopup();
      }

      // ==========================
      // CALENDAR
      // ==========================
      function renderCalendar(entries) {
        const cal = document.getElementById("calendar");
        const title = document.getElementById("monthTitle");
        if (!cal || !title) return;

        cal.innerHTML = "";

        const base = new Date(
          state.viewMonth.getFullYear(),
          state.viewMonth.getMonth(),
          1
        );

        title.textContent = base.toLocaleString("de-DE", {
          month: "long",
          year: "numeric",
        });

        const start = new Date(base);
        const weekday = (start.getDay() + 6) % 7; // Mo=0
        start.setDate(start.getDate() - weekday);

        const counts = buildCounts(entries);
        const todayISO = isoDate(new Date());
        const labels = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];

        labels.forEach((l) => {
          const head = document.createElement("div");
          head.className = "cal-head";
          head.textContent = l;
          cal.appendChild(head);
        });

        const total = getActivePlants().length;

        for (let i = 0; i < 42; i++) {
          const d = new Date(start);
          d.setDate(start.getDate() + i);
          const iso = isoDate(d);

          const cell = document.createElement("button");
          cell.className = "day-btn";

          if (d.getMonth() !== base.getMonth()) cell.style.opacity = "0.35";
          if (iso === todayISO) cell.classList.add("today");
          if (iso === state.selectedISO) cell.classList.add("selected");

          const c = counts.get(iso);

          const badges = [];
          badges.push({ cls: "b-total", text: `üåø${total}` });

          if (c?.hasAny) {
            if (c?.waterDone?.size)
              badges.push({ cls: "b-water", text: `üíß${c.waterDone.size}` });
            if (c?.fertDone?.size)
              badges.push({ cls: "b-fert", text: `üß™${c.fertDone.size}` });
            if (c?.commentsCount)
              badges.push({
                cls: "b-comment comment-badge big-comment",
                text: `üìù${c.commentsCount}`,
                isComment: true,
              });
          }

          const isToday = iso === todayISO;
          cell.innerHTML = `
        <div style="font-weight:900; font-size:16px;">
          ${d.getDate()}
          ${isToday ? `<span class="today-chip">‚ú® Heute</span>` : ``}
        </div>
        <div class="badges">
          ${badges
            .map((b) => {
              if (b.isComment) {
                return `<span class="badge ${b.cls}" onclick="openDayCommentsFromBadge(event,'${iso}')">${b.text}</span>`;
              }
              return `<span class="badge ${b.cls}">${b.text}</span>`;
            })
            .join("")}
        </div>
      `;

          cell.onclick = () => openDayView(iso);
          cal.appendChild(cell);
        }
      }

      function prevMonth() {
        state.viewMonth = new Date(
          state.viewMonth.getFullYear(),
          state.viewMonth.getMonth() - 1,
          1
        );
        renderAll();
      }

      function nextMonth() {
        state.viewMonth = new Date(
          state.viewMonth.getFullYear(),
          state.viewMonth.getMonth() + 1,
          1
        );
        renderAll();
      }

      // ==========================
      // CLEAR ALL
      // ==========================
      function clearAll() {
        if (!confirm("Wirklich alle Eintr√§ge l√∂schen?")) return;
        localStorage.removeItem(STORAGE_KEY);
        out("Alle Eintr√§ge gel√∂scht.");
        renderAll();
      }

      // ==========================
      // RENDER ALL
      // ==========================
      function renderAll() {
        loadPlants(); // ensures defaults exist
        renderPlants();

        const entries = loadEntries();
        renderHistory(entries);
        renderCalendar(entries);

        if (popupISO) renderDayCommentsPopup();
        try {
          fillCommentPlants("dayPopupCommentPlant", true);
        } catch {}
      }

      // ==========================
      // EXPORT FOR inline onclick=""
      // ==========================
      window.openAction = openAction;
      window.openActionWithDate = openActionWithDate;
      window.openActionForSelectedDay = openActionForSelectedDay;

      window.setActionDateToday = setActionDateToday;
      window.selectAllPlants = selectAllPlants;
      window.selectNonePlants = selectNonePlants;
      window.cancelAction = cancelAction;
      window.confirmAction = confirmAction;

      window.openCommentToday = openCommentToday;
      window.closeComment = closeComment;
      window.saveCommentToday = saveCommentToday;

      window.saveDayCommentFromPopup = saveDayCommentFromPopup;

      window.openDayCommentsFromBadge = openDayCommentsFromBadge;
      window.openDayComments = openDayComments;
      window.closeDayComments = closeDayComments;
      window.savePopupComment = savePopupComment;

      window.openDayView = openDayView;
      window.closeDayView = closeDayView;

      window.editComment = editComment;
      window.deleteComment = deleteComment;
      window.togglePinComment = togglePinComment;

      window.prevMonth = prevMonth;
      window.nextMonth = nextMonth;

      window.openHistory = openHistory;
      window.closeHistory = closeHistory;

      window.openPlants = openPlants;
      window.closePlants = closePlants;

      window.addPlant = addPlant;
      window.renamePlant = renamePlant;
      window.removePlant = removePlant;

      window.openRoomDialog = openRoomDialog;
      window.closeRoomDialog = closeRoomDialog;
      window.saveRoomDialog = saveRoomDialog;

      window.deletePlantCancel = deletePlantCancel;
      window.deletePlantDeleteHistory = deletePlantDeleteHistory;
      window.deletePlantKeepHistory = deletePlantKeepHistory;

      window.openPlantOverview = openPlantOverview;
      window.closePlantOverview = closePlantOverview;

      window.openPlantNote = openPlantNote;
      window.closePlantNote = closePlantNote;
      window.savePlantNote = savePlantNote;
      window.clearPlantNote = clearPlantNote;

      window.clearAll = clearAll;

      // ==========================
      // INIT
      // ==========================
      renderAll();
    </script>
  </body>
</html>
