<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Pflanzenlog</title>

    <style>
/* =========================================================
   1) CSS VARIABLES / DESIGN TOKENS
   ========================================================= */
:root {
  --bg0: #06150f;
  --bg1: #0b2418;
  --bg2: #0f3523;

  --glow1: rgba(34, 197, 94, 0.22);
  --glow2: rgba(132, 204, 22, 0.18);

  --card: rgba(255, 255, 255, 0.14);
  --card2: rgba(255, 255, 255, 0.1);
  --stroke: rgba(255, 255, 255, 0.22);

  --text: #ecfdf5;
  --muted: rgba(236, 253, 245, 0.7);

  --waterA: #38bdf8;
  --waterB: #2563eb;

  --fertA: #34d399;
  --fertB: #16a34a;

  --noteA: #fbbf24;
  --noteB: #f97316;

  --dangerA: #fb7185;
  --dangerB: #ef4444;

  --shadow: 0 18px 50px rgba(0, 0, 0, 0.55);
  --soft: 0 10px 26px rgba(0, 0, 0, 0.4);

  --r2: 22px;

  --font: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial,
    "Apple Color Emoji", "Segoe UI Emoji";
}

/* =========================================================
   2) GLOBAL RESET / SAFETY (iOS: kein Rechts-Overflow)
   ========================================================= */
* { box-sizing: border-box; }

html, body {
  max-width: 100%;
  overflow-x: hidden; /* ğŸ”‘ verhindert iOS-Rechts-Scroll/Abschneiden */
}

body {
  font-family: var(--font);
  margin: 0;
  padding: calc(16px + env(safe-area-inset-top))
           calc(16px + env(safe-area-inset-right))
           calc(16px + env(safe-area-inset-bottom))
           calc(16px + env(safe-area-inset-left));
  color: var(--text);
  background:
    radial-gradient(900px 600px at 15% 10%, var(--glow1), transparent 60%),
    radial-gradient(800px 500px at 85% 20%, var(--glow2), transparent 55%),
    radial-gradient(900px 600px at 50% 110%, rgba(20, 184, 166, 0.12), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
}

/* =========================================================
   3) HEADINGS
   ========================================================= */
h1 {
  font-size: 28px;
  letter-spacing: -0.4px;
  margin: 8px 0 14px;
  display: flex;
  align-items: center;
  gap: 10px;
}
h1 .leaf {
  width: 34px;
  height: 34px;
  display: grid;
  place-items: center;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.12);
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: var(--soft);
}
h2 { font-size: 18px; margin: 10px 0; }
h3 { font-size: 16px; margin: 10px 0; }

/* =========================================================
   4) LAYOUT HELPERS
   ========================================================= */
.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  margin-top: 10px;
}

.card,
.top-bar,
.bottom-bar {
  background: linear-gradient(180deg, var(--card), var(--card2));
  border: 1px solid var(--stroke);
  border-radius: var(--r2);
  padding: 14px;
  box-shadow: var(--soft);
  backdrop-filter: blur(16px) saturate(140%);
  -webkit-backdrop-filter: blur(16px) saturate(140%);
}

.top-bar {
  position: sticky;
  top: 0;
  z-index: 20;
  margin-bottom: 12px;
}
.bottom-bar {
  position: sticky;
  bottom: 0;
  z-index: 20;
  margin-top: 12px;
}

#output {
  margin-top: 10px;
  color: var(--muted);
  font-size: 14px;
  min-height: 18px;
}

/* =========================================================
   5) INPUTS
   ========================================================= */
input, select, textarea {
  width: 100%;
  font-size: 16px;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.22);
  background: rgba(255, 255, 255, 0.1);
  color: var(--text);
  outline: none;
}
textarea {
  min-height: 110px;
  resize: vertical;
}
input::placeholder, textarea::placeholder {
  color: rgba(236, 253, 245, 0.55);
}
input:focus, select:focus, textarea:focus {
  border-color: rgba(34, 197, 94, 0.55);
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18);
}

/* =========================================================
   6) BUTTONS (Base + Variants)
   ========================================================= */
button {
  font-size: 16px;
  padding: 12px 18px;
  border-radius: 999px;
  border: 0;
  cursor: pointer;
  color: #fff;
  font-weight: 700;
  letter-spacing: 0.2px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
  box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.28),
              0 10px 22px rgba(0, 0, 0, 0.45);
  transition: transform 0.1s ease, filter 0.15s ease, box-shadow 0.15s ease;
  -webkit-tap-highlight-color: transparent;
}
button:active {
  transform: translateY(2px) scale(0.99);
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.28),
              0 6px 16px rgba(0, 0, 0, 0.4);
}
button:hover { filter: brightness(1.06) saturate(1.08); }

.btn-water { background: linear-gradient(135deg, var(--waterA), var(--waterB)); }
.btn-fert  { background: linear-gradient(135deg, var(--fertA), var(--fertB)); }
.btn-note  { background: linear-gradient(135deg, var(--noteA), var(--noteB)); }

.btn-ghost {
  background: rgba(255, 255, 255, 0.14);
  border: 1px solid rgba(255, 255, 255, 0.22);
  box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
}

.btn-danger { background: linear-gradient(135deg, var(--dangerA), var(--dangerB)); }

/* =========================================================
   7) CALENDAR
   ========================================================= */
#calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  margin-top: 12px;
  width: 100%;
  max-width: 100%;
}
.card { overflow: hidden; }

.cal-head {
  font-weight: 800;
  font-size: 12px;
  color: rgba(236, 253, 245, 0.7);
  text-align: center;
  padding: 2px 4px;
}

.day-btn {
  appearance: none;
  -webkit-appearance: none;

  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 22px;
  padding: 12px;
  min-height: 92px;
  min-width: 0; /* ğŸ”‘ wichtig: Grid darf shrinken */

  background: rgba(255, 255, 255, 0.13);
  color: var(--text);
  text-align: left;

  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);

  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
              0 14px 28px rgba(0, 0, 0, 0.42);

  transition: transform 0.1s ease, box-shadow 0.14s ease, filter 0.14s ease;
  cursor: pointer;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.day-btn:active {
  transform: translateY(2px) scale(0.985);
  filter: brightness(0.98);
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.14),
              0 9px 18px rgba(0, 0, 0, 0.36);
}
.day-btn:focus-visible {
  outline: none;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
              0 14px 28px rgba(0, 0, 0, 0.42),
              0 0 0 3px rgba(34, 197, 94, 0.3);
}

.day-btn.today {
  border-color: rgba(251, 191, 36, 0.35);
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
              0 14px 28px rgba(0, 0, 0, 0.42),
              0 0 0 3px rgba(251, 191, 36, 0.18);
}
.day-btn.selected {
  border-color: rgba(34, 197, 94, 0.45);
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18),
              0 14px 28px rgba(0, 0, 0, 0.42),
              0 0 0 3px rgba(34, 197, 94, 0.22);
}

/* Heute-Chip (Desktop/Standard) */
.today-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 900;
  padding: 3px 8px;
  border-radius: 999px;
  margin-left: 8px;
  background: rgba(251, 191, 36, 0.18);
  border: 1px solid rgba(251, 191, 36, 0.3);
  color: rgba(236, 253, 245, 0.95);
}

/* Badges im Kalender */
.badges {
  margin-top: 8px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  font-size: 12px;
}
.badge {
  border-radius: 999px;
  padding: 4px 10px;
  border: 1px solid rgba(255, 255, 255, 0.22);
  background: rgba(255, 255, 255, 0.12);
  color: rgba(236, 253, 245, 0.92);
  display: inline-flex;
  align-items: center;
  gap: 6px;
  line-height: 1;
}
.badge.b-total   { background: rgba(236, 253, 245, 0.14); border-color: rgba(236, 253, 245, 0.22); }
.badge.b-water   { background: rgba(56, 189, 248, 0.18); border-color: rgba(56, 189, 248, 0.3); }
.badge.b-fert    { background: rgba(52, 211, 153, 0.18); border-color: rgba(52, 211, 153, 0.3); }
.badge.b-comment { background: rgba(251, 191, 36, 0.18); border-color: rgba(251, 191, 36, 0.3); }

.badge.comment-badge { cursor: pointer; }
.badge.big-comment { font-size: 14px; padding: 6px 12px; transform: translateY(-1px); }

/* =========================================================
   8) DIALOGS (Glass: allgemein)
   ========================================================= */
dialog {
  width: min(860px, 92vw);
  border: 1px solid rgba(255, 255, 255, 0.22);
  border-radius: 22px;
  padding: 14px;
  background: linear-gradient(
    180deg,
    rgba(255, 255, 255, 0.16),
    rgba(255, 255, 255, 0.1)
  );
  color: var(--text);
  backdrop-filter: blur(18px) saturate(140%);
  -webkit-backdrop-filter: blur(18px) saturate(140%);
  box-shadow: var(--shadow);
}
dialog::backdrop { background: rgba(0, 0, 0, 0.55); }

ul { margin: 8px 0 0; padding-left: 18px; }
.muted { color: var(--muted); font-size: 13px; }

/* =========================================================
   9) LIST/ITEM CARDS (Plants, Comments, etc.)
   ========================================================= */
.plant-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  align-items: center;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 18px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  margin-top: 8px;
  box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
}
.plant-actions { display: flex; gap: 8px; flex-wrap: wrap; }

.checklist {
  margin-top: 12px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}
.checkitem {
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 18px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
}
.checkitem input {
  width: 20px;
  height: 20px;
  accent-color: #22c55e;
}

.comment-item {
  margin-top: 10px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 18px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
}
.comment-item.pinned {
  background: rgba(251, 191, 36, 0.16);
  border-color: rgba(251, 191, 36, 0.28);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  align-items: center;
}
.comment-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.comment-actions button {
  padding: 10px 12px;
  font-size: 14px;
}
.comment-text {
  margin-top: 8px;
  white-space: pre-wrap;
  color: rgba(236, 253, 245, 0.92);
}

/* Pills */
.pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 14px;
  background: rgba(255, 255, 255, 0.1);
  color: rgba(236, 253, 245, 0.9);
}
.pill input {
  width: 20px;
  height: 20px;
  accent-color: #fbbf24;
}

/* Status Pills */
.status-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 6px;
}
.pill-mini {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.18);
  background: rgba(255, 255, 255, 0.1);
  font-weight: 800;
  font-size: 13px;
  line-height: 1;
}
.pill-mini.water { background: rgba(56, 189, 248, 0.16); border-color: rgba(56, 189, 248, 0.28); }
.pill-mini.fert  { background: rgba(52, 211, 153, 0.16); border-color: rgba(52, 211, 153, 0.28); }
.pill-mini.note  { background: rgba(251, 191, 36, 0.16); border-color: rgba(251, 191, 36, 0.28); }
.pill-mini.none  { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.16); opacity: 0.9; }

.mini-label {
  font-size: 13px;
  font-weight: 800;
  color: rgba(236, 253, 245, 0.82);
}

/* =========================================================
   10) TOPBAR ICONS (User / Settings)
   ========================================================= */
.topbar-spacer { flex: 1; }

.icon-btn {
  width: 44px;
  height: 44px;
  padding: 0;
  border-radius: 999px;
  display: inline-grid;
  place-items: center;
  font-size: 18px;
}

/* =========================================================
   11) ğŸ“± iPhone / kleine Displays
   ========================================================= */
@media (max-width: 430px) {
  body {
    padding-left: calc(12px + env(safe-area-inset-left));
    padding-right: calc(12px + env(safe-area-inset-right));
  }

  /* Kalender kompakter */
  #calendar { gap: 6px; }

  .day-btn {
    padding: 8px;
    min-height: 72px;
    border-radius: 18px;
    min-width: 0;
  }

  .badges {
    gap: 4px;
    margin-top: 6px;
    font-size: 11px;
  }

  .badge { padding: 3px 8px; }

  /* ğŸ“ Kommentar-Badge kleiner */
  .badge.big-comment {
    font-size: 11px;
    padding: 3px 7px;
    border-radius: 999px;
  }

  /* âœ¨ Heute-Chip dezenter */
  .today-chip {
    display: inline-block;
    font-size: 9px;
    padding: 2px 6px;
    margin-left: 4px;
    transform: translateY(-1px);
  }

  /* Datum minimal kleiner */
  .day-btn > div:first-child {
    font-size: 14px;
  }

  /* Topbar Icons kleiner */
  .icon-btn {
    width: 40px;
    height: 40px;
    font-size: 17px;
  }
}

/* =========================================================
   12) MenÃ¼-Dialoge (User/Settings) = Dark Glass + bessere Lesbarkeit
   ========================================================= */
#settingsMenuDialog,
#userMenuDialog {
  background: linear-gradient(
    180deg,
    rgba(6, 21, 15, 0.88),
    rgba(11, 36, 24, 0.85)
  );
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: 0 30px 70px rgba(0, 0, 0, 0.6);
}

/* Buttons im MenÃ¼ besser lesbar */
#settingsMenuDialog .btn-ghost,
#userMenuDialog .btn-ghost {
  background: rgba(255, 255, 255, 0.18);
  color: var(--text);
  border: 1px solid rgba(255, 255, 255, 0.28);
}

/* Import Label wie normaler Button */
#settingsMenuDialog label.btn-ghost {
  background: rgba(255, 255, 255, 0.18);
  color: var(--text);
  border-radius: 999px;
  padding: 12px 18px;
}
      /* Admin-Hinweis im MenÃ¼ */
#adminHintRow {
  padding: 10px 12px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.16);
  background: rgba(255,255,255,0.08);
}
</style>


  </head>

  <body>
    <h1><span class="leaf">ğŸŒ¿</span> Pflanzenlog</h1>

    <div class="top-bar">
      <div class="row" style="margin-top: 0">
  <button class="btn-water" onclick="openAction('water')">ğŸ’§ GieÃŸen</button>
  <button class="btn-fert" onclick="openAction('fertilize')">ğŸ§ª DÃ¼ngen</button>
  <button class="btn-note" onclick="openCommentToday()">ğŸ“ Kommentar (heute)</button>
  <button class="btn-ghost" onclick="openPlantOverview()">ğŸª´ PflanzenÃ¼bersicht</button>

  <span class="topbar-spacer"></span>

  <button class="btn-ghost icon-btn" onclick="openUserMenu()" title="Login / User">
    ğŸ‘¤
  </button>
  <button class="btn-ghost icon-btn" onclick="openSettingsMenu()" title="MenÃ¼">
    âš™ï¸
  </button>
</div>

      <p id="output"></p>
    </div>

    <div class="card" id="authCard" style="margin-bottom: 12px">
      <h2>Login</h2>
      <div class="row">
        <input
          id="emailInput"
          type="email"
          placeholder="deine@email.de"
          style="flex: 1"
        />
        <button class="btn-note" onclick="sendMagicLink()">
          Magic Link senden
        </button>
      </div>
      <div class="row" style="justify-content: space-between">
        <span class="muted" id="authStatus">Nicht eingeloggt</span>
        <button class="btn-ghost" onclick="logout()">Logout</button>
        <button id="btnWipeSupabase" class="btn-danger" onclick="wipeSupabaseData()">
  ğŸ§¨ Supabase-Daten lÃ¶schen
</button>

<button id="btnPushSupabase" class="btn-note" onclick="pushLocalToSupabase()">
  â˜ï¸ Lokal â†’ Supabase
</button>

      </div>
      <div id="adminHintRow" class="row" style="margin-top: 10px">
  <span class="muted">ğŸ”’ Adminbereich (Supabase) â€“ nur fÃ¼r den Besitzer dieser App.</span>
</div>
    </div>

    <div class="card">
      <h2>Kalender</h2>

      <div class="row" style="justify-content: space-between; margin-top: 0">
        <button class="btn-ghost" onclick="prevMonth()">â—€</button>
        <strong id="monthTitle"></strong>
        <button class="btn-ghost" onclick="nextMonth()">â–¶</button>
      </div>

      <div id="calendar"></div>
    </div>
    </div>

    <!-- ğŸ“… Tagesansicht (Popup) -->
    <dialog id="dayViewDialog">
      <h2 id="dayViewTitle">ğŸ“… Tagesansicht</h2>

      <!-- âœ… Schnell: fÃ¼r diesen Tag nachtragen -->
      <div class="row" style="margin-top: 6px">
        <button class="btn-water" onclick="openActionForSelectedDay('water')">
          ğŸ’§ GieÃŸen nachtragen
        </button>
        <button
          class="btn-fert"
          onclick="openActionForSelectedDay('fertilize')"
        >
          ğŸ§ª DÃ¼ngen nachtragen
        </button>
      </div>
      
      <div id="dayViewBody"></div>

      <div class="comment-item" style="margin-top: 12px">
        <b>â• Kommentar hinzufÃ¼gen</b>

        <div class="row" style="margin-top: 8px">
          <select id="dayPopupCommentPlant" style="flex: 1"></select>
        </div>

        <textarea
          id="dayPopupCommentText"
          placeholder="Kommentar zu diesem Tagâ€¦"
        ></textarea>

        <div class="row" style="margin-top: 8px">
          <label class="pill">
            <input id="dayPopupCommentPinned" type="checkbox" />
            ğŸ“Œ anpinnen
          </label>
          <button class="btn-note" onclick="saveDayCommentFromPopup()">
            Speichern
          </button>
        </div>
      </div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closeDayView()">SchlieÃŸen</button>
      </div>
    </dialog>

    <!-- Verlauf -->
    <dialog id="historyDialog">
      <h2>Verlauf</h2>
      <ul id="history"></ul>

      <div class="row">
        <button class="btn-danger" onclick="clearAll()">
          ğŸ—‘ï¸ Alle EintrÃ¤ge lÃ¶schen
        </button>
        <button class="btn-ghost" onclick="closeHistory()">SchlieÃŸen</button>
      </div>
    </dialog>

    <!-- Pflanzen verwalten -->
    <dialog id="plantsDialog">
      <h2>Pflanzen verwalten</h2>

      <div class="row">
        <input
          id="newPlant"
          placeholder="Neue Pflanze (z. B. Ficus)"
          style="flex: 1"
        />

        <select id="newRoom" style="flex: 1">
          <option>Wohnzimmer</option>
          <option>Schlafzimmer</option>
          <option>Flur</option>
          <option>BÃ¼ro</option>
        </select>

        <button class="btn-ghost" onclick="addPlant()">â• HinzufÃ¼gen</button>
      </div>

      <div class="muted" style="margin-top: 8px">
        RÃ¤ume fÃ¼r neue Pflanzen: Wohnzimmer, Schlafzimmer, Flur, BÃ¼ro.
        <br />â€Entfernte Pflanzenâ€œ wird automatisch genutzt, wenn du Historie
        behalten willst.
      </div>

      <div id="plantsList" style="margin-top: 12px"></div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closePlants()">SchlieÃŸen</button>
      </div>
    </dialog>

    <!-- ğŸ  Raum Ã¤ndern -->
    <dialog id="roomDialog">
      <h2>ğŸ  Raum Ã¤ndern</h2>
      <p class="muted" id="roomPlantLabel"></p>

      <div class="row" style="margin-top: 6px">
        <select id="roomSelect" style="flex: 1"></select>
      </div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closeRoomDialog()">Abbrechen</button>
        <button class="btn-note" onclick="saveRoomDialog()">Speichern</button>
      </div>
    </dialog>

    <!-- Pflanze lÃ¶schen -->
    <dialog id="deletePlantDialog">
      <h2>Pflanze lÃ¶schen</h2>
      <p id="deletePlantText"></p>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="deletePlantCancel()">
          Abbrechen
        </button>
        <button class="btn-danger" onclick="deletePlantDeleteHistory()">
          Historie lÃ¶schen
        </button>
        <button class="btn-ghost" onclick="deletePlantKeepHistory()">
          Historie behalten
        </button>
      </div>
    </dialog>

    <!-- âœ… Action Dialog (mit Datum) -->
    <dialog id="actionDialog">
      <h2 id="actionTitle"></h2>
      <p class="muted" id="actionHint"></p>

      <div class="comment-item" id="actionDateBlock" style="margin-top: 10px">
        <div class="mini-label">ğŸ“… Datum</div>
        <div class="row" style="margin-top: 8px">
          <input id="actionDate" type="date" style="flex: 1" />
          <button
            id="actionDateTodayBtn"
            class="btn-ghost"
            onclick="setActionDateToday()"
          >
            Heute
          </button>
        </div>

        <div class="muted" style="margin-top: 6px"></div>
      </div>

      <div class="row" style="margin-top: 10px">
        <button class="btn-ghost" onclick="selectAllPlants()">
          âœ… Alle auswÃ¤hlen
        </button>
        <button class="btn-ghost" onclick="selectNonePlants()">
          ğŸš« Keine auswÃ¤hlen
        </button>
      </div>

      <div id="actionList" class="checklist"></div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="cancelAction()">Abbrechen</button>
        <button class="btn-note" onclick="confirmAction()">Speichern</button>
      </div>
    </dialog>

    <!-- Kommentar Dialog (HEUTE) -->
    <dialog id="commentDialog">
      <h2>ğŸ“ Kommentar (heute)</h2>

      <label for="commentPlant">Pflanze</label>
      <div class="row" style="margin-top: 6px">
        <select id="commentPlant" style="flex: 1"></select>
      </div>

      <label for="commentText" style="display: block; margin-top: 10px"
        >Kommentar</label
      >
      <textarea
        id="commentText"
        placeholder="z. B. BlÃ¤tter hÃ¤ngen, Erde trocken..."
      ></textarea>

      <div class="row" style="margin-top: 8px">
        <label class="pill">
          <input id="commentPinned" type="checkbox" />
          ğŸ“Œ anpinnen
        </label>
      </div>

      <div class="row" style="margin-top: 12px">
        <button class="btn-ghost" onclick="closeComment()">Abbrechen</button>
        <button class="btn-note" onclick="saveCommentToday()">Speichern</button>
      </div>
    </dialog>

    <!-- ğŸ“ Popup pro Tag (klickbares Badge im Kalender) -->
    <dialog id="dayCommentsDialog">
      <h2 id="dayCommentsTitle"></h2>

      <div id="dayCommentsList"></div>

      <h3 style="margin-top: 12px">â• Neuer Kommentar fÃ¼r diesen Tag</h3>

      <div class="row" style="margin-top: 6px">
        <select id="popupCommentPlant" style="flex: 1"></select>
      </div>

      <textarea id="popupCommentText" placeholder="Kommentarâ€¦"></textarea>

      <div class="row" style="margin-top: 8px">
        <label class="pill">
          <input id="popupCommentPinned" type="checkbox" />
          ğŸ“Œ anpinnen
        </label>
        <button class="btn-note" onclick="savePopupComment()">Speichern</button>
        <button class="btn-ghost" onclick="closeDayComments()">
          SchlieÃŸen
        </button>
      </div>
    </dialog>

    <!-- ğŸª´ PflanzenÃ¼bersicht -->
<dialog id="plantOverviewDialog">
  <div class="row" style="margin-top: 0; justify-content: space-between;">
    <h2 style="margin: 0;">ğŸª´ PflanzenÃ¼bersicht</h2>
    <button class="btn-ghost" onclick="openPlantsFromOverview()">ğŸ›  Pflanzen verwalten</button>
  </div>

  <div id="plantOverviewList" style="margin-top: 12px;"></div>

  <div class="row" style="margin-top: 12px">
    <button class="btn-ghost" onclick="closePlantOverview()">SchlieÃŸen</button>
  </div>
</dialog>

    <!-- ğŸ“ Pflanzenkommentar (tagesunabhÃ¤ngig) -->
    <dialog id="plantNoteDialog">
      <h2 id="plantNoteTitle">ğŸ“ Pflanzenkommentar</h2>

      <textarea
        id="plantNoteText"
        placeholder="Kommentar zur Pflanze (tagesunabhÃ¤ngig)â€¦"
      ></textarea>

      <div class="row" style="margin-top: 12px">
        <button class="btn-danger" onclick="clearPlantNote()">
          ğŸ—‘ï¸ LÃ¶schen
        </button>
        <button class="btn-ghost" onclick="closePlantNote()">Abbrechen</button>
        <button class="btn-note" onclick="savePlantNote()">Speichern</button>
      </div>
    </dialog>
    <!-- ğŸ‘¤ User MenÃ¼ (Login / Logout) -->
<dialog id="userMenuDialog">
  <h2>ğŸ‘¤ Login</h2>

  <div class="row">
    <input
      id="emailInput2"
      type="email"
      placeholder="deine@email.de"
      style="flex: 1"
    />
    <button class="btn-note" onclick="sendMagicLinkFromUserMenu()">
      Magic Link senden
    </button>
  </div>

  <div class="row" style="justify-content: space-between">
    <span class="muted" id="authStatus2">Nicht eingeloggt</span>
    <button class="btn-ghost" onclick="logout()">Logout</button>
  </div>

  <div class="row" style="margin-top: 12px">
    <button class="btn-ghost" onclick="closeUserMenu()">SchlieÃŸen</button>
  </div>
</dialog>

<!-- âš™ï¸ Settings MenÃ¼ -->
<dialog id="settingsMenuDialog">
  <h2>âš™ï¸ MenÃ¼</h2>

  <div class="row">
    <button class="btn-ghost" onclick="openHistory()">ğŸ“œ Verlauf anzeigen</button>
    <button class="btn-ghost" onclick="openPlants()">ğŸª´ Pflanzen verwalten</button>
  </div>

  <div class="row">
    <button class="btn-ghost" onclick="exportLocalData()">â¬‡ï¸ Backup export</button>

    <label
      class="btn-ghost"
      style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;"
    >
      â¬†ï¸ Import
      <input
        type="file"
        accept="application/json"
        style="display:none"
        onchange="importLocalData(this.files[0])"
      />
    </label>
  </div>

  <!-- (VorlÃ¤ufig) Supabase Buttons auch hier â€“ Schutz machen wir als eigenen Schritt -->
  <div class="row" style="margin-top: 10px">
    <button class="btn-danger" onclick="wipeSupabaseData()">ğŸ§¨ Supabase-Daten lÃ¶schen</button>
    <button class="btn-note" onclick="pushLocalToSupabase()">â˜ï¸ Lokal â†’ Supabase</button>
  </div>

  <div class="row" style="margin-top: 12px">
    <button class="btn-ghost" onclick="closeSettingsMenu()">SchlieÃŸen</button>
  </div>
</dialog>
  
    
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 
    <script>
      const DEBUG_ENABLED = false;
   /* =========================================================
   0) iPad Debug Console (robust)
   ========================================================= */
if (DEBUG_ENABLED) {
  (function () {
    let box = null;
    const buffer = [];
    (function () {
  let box = null;
  const buffer = [];

  function ensureBox() {
    if (box) return box;
    if (!document.body) return null;

    box = document.createElement("div");
    box.id = "debugConsole";
    box.style.cssText = `
      position: fixed; left: 10px; right: 10px; bottom: 10px;
      max-height: 40vh; overflow: auto; z-index: 999999;
      background: rgba(0,0,0,.78); color: #fff;
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 14px; padding: 10px; font: 12px/1.4 -apple-system,system-ui;
      white-space: pre-wrap;
    `;
    box.textContent = "ğŸ§ª Debug-Console aktiv\n";
    document.body.appendChild(box);

    buffer.splice(0).forEach((line) => (box.textContent += line + "\n"));
    box.scrollTop = box.scrollHeight;
    return box;
  }

  function write(prefix, args) {
    const msg = Array.from(args).map((a) => {
      try { return typeof a === "string" ? a : JSON.stringify(a); }
      catch { return String(a); }
    }).join(" ");
    const line = `${prefix} ${msg}`;

    const b = ensureBox();
    if (b) { b.textContent += line + "\n"; b.scrollTop = b.scrollHeight; }
    else buffer.push(line);
  }

  const origLog = console.log.bind(console);
  const origErr = console.error.bind(console);

  console.log = (...args) => { origLog(...args); write("LOG:", args); };
  console.error = (...args) => { origErr(...args); write("ERR:", args); };

  window.addEventListener("error", (e) => {
    console.error("Uncaught:", e.message, "at", e.filename + ":" + e.lineno);
  });
  window.addEventListener("unhandledrejection", (e) => {
    console.error("Promise rejection:", e.reason);
  });

  document.addEventListener("DOMContentLoaded", () => {
    ensureBox();
    console.log("DOMContentLoaded âœ…");
  });

  // sofort loggen
  console.log("DEBUG SCRIPT LOADED âœ…");
})();
    </script>
  
  <script>
/* =========================================================
   1) Supabase Setup (Safari fix + Session persist)
   ========================================================= */
const SUPABASE_URL = "https://bwdjojgquyjnydhdyuqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_9duw_kZYTLARlp9wTDDZPQ_SOpPxSNg";

const sbLib = window.supabase || globalThis.supabase;
if (!sbLib || typeof sbLib.createClient !== "function") {
  console.error("Supabase SDK nicht geladen (createClient fehlt).");
}

function fetchWithTimeout(url, options = {}) {
  const controller = new AbortController();
  const timeoutMs = 12000; // 12s
  const id = setTimeout(() => controller.abort(), timeoutMs);

  return fetch(url, {
    ...options,
    signal: controller.signal,
  }).finally(() => clearTimeout(id));
}

const supabaseClient =
  sbLib && typeof sbLib.createClient === "function"
    ? sbLib.createClient(SUPABASE_URL.replace(/\/$/, ""), SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: window.localStorage,
        },
        global: {
          fetch: fetchWithTimeout, // ğŸ‘ˆ Safari-Fix
        },
      })
    : null;

/* =========================================================
   1a) Current User Helper (RLS-Fix)
   ========================================================= */
let CURRENT_USER_ID = null;

async function getUserId() {
  if (CURRENT_USER_ID) return CURRENT_USER_ID;
  if (!supabaseClient) return null;

  const { data, error } = await supabaseClient.auth.getUser();
  if (error) throw error;

  CURRENT_USER_ID = data?.user?.id || null;
  return CURRENT_USER_ID;
}

/* =========================================================
   2) Keys (Local Cache)
   ========================================================= */
const STORAGE_KEY = "pflanzenlog_entries_v12";
const PLANTS_KEY = "pflanzenlog_plants_v3_rooms_active";
const PLANT_NOTES_KEY = "pflanzenlog_plant_notes_v1";

    /* =========================================================
   QUEUE / AUTO-SYNC: Dirty Flags + Cloud Mode
   ========================================================= */

const DIRTY_ENTRIES_KEY = "pflanzenlog_dirty_entries_v1";
const DIRTY_PLANTS_KEY  = "pflanzenlog_dirty_plants_v1";
const DIRTY_NOTES_KEY   = "pflanzenlog_dirty_notes_v1";

function setDirty(key, val) {
  try { localStorage.setItem(key, val ? "1" : "0"); } catch {}
}
function isDirty(key) {
  try { return localStorage.getItem(key) === "1"; } catch { return false; }
}
function clearDirty(key) {
  try { localStorage.removeItem(key); } catch {}
}

function markDirtyEntries() { setDirty(DIRTY_ENTRIES_KEY, true); }
function markDirtyPlants()  { setDirty(DIRTY_PLANTS_KEY, true); }
function markDirtyNotes()   { setDirty(DIRTY_NOTES_KEY, true); }

function clearDirtyEntries(){ clearDirty(DIRTY_ENTRIES_KEY); }
function clearDirtyPlants() { clearDirty(DIRTY_PLANTS_KEY); }
function clearDirtyNotes()  { clearDirty(DIRTY_NOTES_KEY); }

async function isCloudMode() {
  if (!supabaseClient) return false;
  const session = await getSessionSafe().catch(() => null);
  return !!session;
}

/* =========================================================
   3) Rooms / State
   ========================================================= */
const ROOMS_BASE = ["Wohnzimmer", "Schlafzimmer", "Flur", "BÃ¼ro"];
const REMOVED_ROOM = "Entfernte Pflanzen";
const ROOMS_ALL = [...ROOMS_BASE, REMOVED_ROOM];
const GENERAL_COMMENT_KEY = "__GENERAL_DAY__";

const state = {
  viewMonth: new Date(),
  selectedISO: isoDate(new Date()),
};

let pendingAction = null;
let popupISO = null;
let actionISO = isoDate(new Date());
let actionDateLocked = false;

/* =========================================================
   4) Helpers
   ========================================================= */
function isoDate(d) {
  const x = new Date(d);
  const y = x.getFullYear();
  const m = String(x.getMonth() + 1).padStart(2, "0");
  const day = String(x.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function out(msg) {
  const el = document.getElementById("output");
  if (el) el.textContent = msg || "";
}

// --- globals used across dialogs / actions ---
let pendingRoomPlant = null;
let pendingPlantToDelete = null;
let pendingPlantForNote = null;

// --- Dialog helpers ---
function openDialog(id) {
  const dlg = document.getElementById(id);
  if (!dlg) {
    console.error("openDialog: Dialog nicht gefunden:", id);
    return;
  }
  if (typeof dlg.showModal === "function") {
    if (!dlg.open) dlg.showModal();
  } else {
    dlg.setAttribute("open", "open");
  }
}
function closeDialog(id) {
  const dlg = document.getElementById(id);
  if (!dlg) return;
  if (typeof dlg.close === "function") {
    if (dlg.open) dlg.close();
  } else {
    dlg.removeAttribute("open");
  }
}

// Backdrop click closes dialog
(function enableDialogBackdropClose() {
  document.addEventListener("click", (e) => {
    const dlg = e.target;
    if (dlg && dlg.tagName === "DIALOG") {
      const rect = dlg.getBoundingClientRect();
      const inDialog =
        e.clientX >= rect.left &&
        e.clientX <= rect.right &&
        e.clientY >= rect.top &&
        e.clientY <= rect.bottom;
      if (!inDialog) dlg.close();
    }
  });
})();

function uniq(arr) {
  if (!Array.isArray(arr)) return [];
  return Array.from(new Set(arr.filter((x) => x !== null && x !== undefined)));
}
function setUnion(a, b) {
  const aa = Array.isArray(a) ? a : [];
  const bb = Array.isArray(b) ? b : [];
  return uniq([...aa, ...bb]);
}
function escapeHtml(str) {
  const s = String(str ?? "");
  return s
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}
function uuid() {
  if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
    return crypto.randomUUID();
  }
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}
function isoToNoonTs(iso) {
  const [y, m, d] = String(iso || "").split("-").map((x) => parseInt(x, 10));
  if (!y || !m || !d) return Date.now();
  return new Date(y, m - 1, d, 12, 0, 0, 0).getTime();
}

/* =========================================================
   QUEUE STATUS HINT (UI)
   ========================================================= */
async function updateQueueStatusHint() {
  const cloud = await isCloudMode();

  const dirty =
    isDirty(DIRTY_ENTRIES_KEY) ||
    isDirty(DIRTY_PLANTS_KEY) ||
    isDirty(DIRTY_NOTES_KEY);

  if (!cloud && dirty) {
    out("ğŸŸ¡ Lokal gespeichert â€“ wird nach Login synchronisiert.");
    return;
  }

  if (!cloud && !dirty) {
    out("ğŸ“± Lokalmodus â€“ keine Cloud-Synchronisation aktiv.");
    return;
  }

  if (cloud && dirty) {
    out("â³ Ã„nderungen werden synchronisiert â€¦");
    return;
  }

  if (cloud && !dirty) {
    out("â˜ï¸ Alles synchronisiert.");
  }
}
    
/* =========================================================
   5) Local Cache (Entries / Plants / Notes)
   ========================================================= */
function loadEntriesFromLocal() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}
function saveEntriesToLocal(entries) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries || []));
}

function loadPlantsFromLocal() {
  try { return JSON.parse(localStorage.getItem(PLANTS_KEY)) || []; }
  catch { return []; }
}
function savePlantsToLocal(plants) {
  localStorage.setItem(PLANTS_KEY, JSON.stringify(plants || []));
}

function loadNotesFromLocal() {
  try { return JSON.parse(localStorage.getItem(PLANT_NOTES_KEY)) || {}; }
  catch { return {}; }
}
function saveNotesToLocal(map) {
  localStorage.setItem(PLANT_NOTES_KEY, JSON.stringify(map || {}));
}

/* =========================================================
   6) Supabase Helpers (payload tables)
   ========================================================= */
function promiseTimeout(promise, ms, label = "operation") {
  return new Promise((resolve, reject) => {
    const t = setTimeout(() => reject(new Error(`Timeout after ${ms}ms (${label})`)), ms);
    promise
      .then((v) => { clearTimeout(t); resolve(v); })
      .catch((e) => { clearTimeout(t); reject(e); });
  });
}

async function sbFetchPayloads(table) {
  if (!supabaseClient) throw new Error("supabaseClient ist null");
  console.log(`â¬‡ï¸ [${table}] select startâ€¦`);

  // Query
  const queryPromise = supabaseClient
    .from(table)
    .select("payload, ts")
    .order("ts", { ascending: false });

  // Timeout guard
  const { data, error } = await promiseTimeout(queryPromise, 12000, `${table}.select`);
  if (error) throw error;

  console.log(`âœ… [${table}] select done (${(data || []).length} rows)`);
  return (data || []).map((r) => r.payload).filter(Boolean);
}

async function sbReplaceAll(table, payloads, tsGetter) {
  if (!supabaseClient) throw new Error("supabaseClient ist null");

  const userId = await getUserId();
  if (!userId) throw new Error("Kein User eingeloggt (user_id fehlt)");

  console.log(`â˜ï¸ [${table}] replaceAll fÃ¼r user`, userId);

  const { error: delErr } = await supabaseClient
    .from(table)
    .delete()
    .eq("user_id", userId);

  if (delErr) throw delErr;

  const rows = (payloads || []).map((p) => ({
    user_id: userId,
    ts: typeof tsGetter === "function" ? tsGetter(p) || Date.now() : Date.now(),
    payload: p,
  }));

  if (!rows.length) {
    console.log(`â„¹ï¸ [${table}] nichts zu speichern`);
    return;
  }

  const CHUNK = 200;
  for (let i = 0; i < rows.length; i += CHUNK) {
    const slice = rows.slice(i, i + CHUNK);
    const { error } = await supabaseClient.from(table).insert(slice);
    if (error) throw error;
  }

  console.log(`âœ… [${table}] Sync abgeschlossen (${rows.length} rows)`);
}

/* =========================================================
   7) Public Data API (lokal + auto-sync)
   ========================================================= */
function loadEntries() {
  return loadEntriesFromLocal();
}
let syncTimerEntries = null;
function saveEntries(entries) {
  saveEntriesToLocal(entries);
  markDirtyEntries(); // âœ… queued: es gibt lokale Ã„nderungen

  // âœ… Nur syncen, wenn wirklich Cloud-Mode (eingeloggt)
  isCloudMode().then((cloud) => {
    if (cloud) scheduleEntriesSync(entries);
    updateQueueStatusHint();
  });
}

function scheduleEntriesSync(entries) {
  if (syncTimerEntries) clearTimeout(syncTimerEntries);
  syncTimerEntries = setTimeout(async () => {
    try {
      console.log("â˜ï¸ Sync entriesâ€¦");
      out("â˜ï¸ Sync entriesâ€¦");
      await sbReplaceAll("entries", entries, (e) => e?.ts || Date.now());
      console.log("âœ… entries synced");
      out("âœ… Supabase Sync ok");
    } catch (e) {
      console.error("âŒ entries sync error (full):", e);
      const msg = e?.message || String(e);
      const code = e?.code || e?.status || "";
      const details = e?.details || e?.hint || "";
      out(`âŒ Supabase (${code}) ${msg} ${details}`.trim());
    }
  }, 600);
}

function loadPlants() {
  const local = loadPlantsFromLocal();
  return Array.isArray(local) ? local : [];
}
let syncTimerPlants = null;
function savePlants(plants) {
  savePlantsToLocal(plants || []);
  markDirtyPlants(); // âœ… queued

  isCloudMode().then((cloud) => {
    if (cloud) schedulePlantsSync(plants || []);
    updateQueueStatusHint();
  });
}

function schedulePlantsSync(plants) {
  if (syncTimerPlants) clearTimeout(syncTimerPlants);
  syncTimerPlants = setTimeout(async () => {
    try {
      console.log("â˜ï¸ Sync plantsâ€¦");
      out("â˜ï¸ Sync plantsâ€¦");
      await sbReplaceAll("plants", plants, () => Date.now());
      console.log("âœ… plants synced");
      out("âœ… Supabase Sync ok");
    } catch (e) {
      console.error("âŒ plants sync error (full):", e);
      const msg = e?.message || String(e);
      const code = e?.code || e?.status || "";
      const details = e?.details || e?.hint || "";
      out(`âŒ Supabase (${code}) ${msg} ${details}`.trim());
    }
  }, 600);
}

function loadPlantNotes() {
  return loadNotesFromLocal();
}
let syncTimerNotes = null;
function savePlantNotes(map) {
  saveNotesToLocal(map || {});
  markDirtyNotes(); // âœ… queued

  isCloudMode().then((cloud) => {
    if (cloud) scheduleNotesSync(map || {});
    updateQueueStatusHint();
  });
}

function scheduleNotesSync(map) {
  if (syncTimerNotes) clearTimeout(syncTimerNotes);
  syncTimerNotes = setTimeout(async () => {
    try {
      console.log("â˜ï¸ Sync plant_notesâ€¦");
      out("â˜ï¸ Sync plant notesâ€¦");
      await sbReplaceAll("plant_notes", [map], () => Date.now());
      console.log("âœ… plant_notes synced");
      out("âœ… Supabase Sync ok");
    } catch (e) {
      console.error("âŒ plant_notes sync error (full):", e);
      const msg = e?.message || String(e);
      const code = e?.code || e?.status || "";
      const details = e?.details || e?.hint || "";
      out(`âŒ Supabase (${code}) ${msg} ${details}`.trim());
    }
  }, 600);
}

/* =========================================================
   8) Auth (Magic Link) + UI Hooks
   ========================================================= */
function updateAuthUI(session) {
  const status = document.getElementById("authStatus");
  if (!status) return;
  status.textContent = session?.user
    ? `Eingeloggt: ${session.user.email || session.user.id}`
    : "Nicht eingeloggt";
}

let MAGIC_LINK_COOLDOWN_UNTIL = 0;

async function sendMagicLink() {
  try {
    if (!supabaseClient) throw new Error("supabaseClient fehlt");

    const now = Date.now();
    if (now < MAGIC_LINK_COOLDOWN_UNTIL) {
      const sec = Math.ceil((MAGIC_LINK_COOLDOWN_UNTIL - now) / 1000);
      out(`â³ Bitte ${sec}s warten, dann nochmal.`);
      return;
    }

    const email = (document.getElementById("emailInput")?.value || "").trim();
    if (!email) return out("Bitte Email eingeben ğŸ™‚");

    out("ğŸ“¨ Magic Link wird gesendetâ€¦");
    console.log("ğŸ“¨ sende Magic Link an", email);

    const redirectTo = window.location.origin + window.location.pathname;
    console.log("â†ªï¸ redirectTo:", redirectTo);

    const { data, error } = await supabaseClient.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: redirectTo },
    });

    if (error) {
      if (error.status === 429) {
        MAGIC_LINK_COOLDOWN_UNTIL = Date.now() + 6500;
        out("â³ Supabase Sicherheitslimit: bitte 6 Sekunden warten und nochmal.");
      } else {
        out("âŒ Magic Link Fehler: " + (error.message || "unbekannt"));
      }
      console.error("âŒ Magic Link Fehler:", error);
      return;
    }

    MAGIC_LINK_COOLDOWN_UNTIL = Date.now() + 6500;
    out("âœ… Link gesendet! Check deine Mail ğŸ˜Š");
    console.log("âœ… Magic Link gesendet", data);
  } catch (e) {
    console.error("âŒ Magic Link Exception:", e);
    out("âŒ Magic Link Exception: " + (e?.message || String(e)));
  }
}

async function logout() {
  try {
    if (!supabaseClient) throw new Error("supabaseClient fehlt");
    await supabaseClient.auth.signOut();
    CURRENT_USER_ID = null;
    out("ğŸ‘‹ Ausgeloggt.");
    console.log("ğŸ‘‹ ausgeloggt");
    updateAuthUI(null);
    if (typeof renderAll === "function") renderAll();
  } catch (e) {
    console.error("âŒ Logout Fehler:", e);
    out("âŒ Logout Fehler: " + (e?.message || e));
  }
}

async function getSessionSafe() {
  if (!supabaseClient) throw new Error("supabaseClient fehlt");
  const { data, error } = await supabaseClient.auth.getSession();
  if (error) throw error;
  return data.session;
}

/* =========================================================
   AUTO-SYNC: Local -> Supabase wenn dirty
   ========================================================= */
async function autoSyncAllIfDirty() {
  if (!supabaseClient) return;

  const session = await getSessionSafe().catch(() => null);
  if (!session) return;

  const dirtyEntries = isDirty(DIRTY_ENTRIES_KEY);
  const dirtyPlants  = isDirty(DIRTY_PLANTS_KEY);
  const dirtyNotes   = isDirty(DIRTY_NOTES_KEY);

  if (!dirtyEntries && !dirtyPlants && !dirtyNotes) {
    console.log("ğŸŸ¢ AutoSync: nichts dirty");
    return;
  }

  out("â˜ï¸ Sync (Queue) â€¦");
  console.log("â˜ï¸ AutoSync startet:", { dirtyEntries, dirtyPlants, dirtyNotes });

  try {
    // Reihenfolge: Plants -> Notes -> Entries (macht Sinn fÃ¼rs UI)
    if (dirtyPlants) {
      const plants = loadPlantsFromLocal();
      await sbReplaceAll("plants", plants, () => Date.now());
      clearDirtyPlants();
      updateQueueStatusHint();
      console.log("âœ… AutoSync plants done");
    }

    if (dirtyNotes) {
      const notes = loadNotesFromLocal();
      await sbReplaceAll("plant_notes", [notes], () => Date.now());
      clearDirtyNotes();
      updateQueueStatusHint();
      console.log("âœ… AutoSync notes done");
    }

    if (dirtyEntries) {
      const entries = loadEntriesFromLocal();
      await sbReplaceAll("entries", entries, (e) => e?.ts || Date.now());
      clearDirtyEntries();
      updateQueueStatusHint();
      console.log("âœ… AutoSync entries done");
    }

    out("âœ… Queue Sync fertig");
  } catch (e) {
    console.error("âŒ AutoSync Fehler:", e);
    out("âŒ AutoSync fehlgeschlagen: " + (e?.message || e));
    // dirty bleibt bewusst gesetzt -> nÃ¤chster Login/Reload versucht es erneut
  }
}
    
/* =========================================================
   9) INIT: FAST remote load (parallel) + NO auto-upload on start
   ========================================================= */
async function initFromSupabase_FAST() {
  if (!supabaseClient) throw new Error("supabaseClient fehlt");

// Wenn lokal pending Ã„nderungen existieren, NICHT Ã¼berschreiben
const hasPending =
  isDirty(DIRTY_ENTRIES_KEY) ||
  isDirty(DIRTY_PLANTS_KEY) ||
  isDirty(DIRTY_NOTES_KEY);

if (hasPending) {
  console.log("ğŸŸ¡ Pending local changes -> skip initFromSupabase overwrite");
  out("ğŸŸ¡ Lokale Ã„nderungen warten â€“ erst synchronisierenâ€¦");
  return;
}
  
  const results = await Promise.allSettled([
    sbFetchPayloads("entries"),
    sbFetchPayloads("plants"),
    sbFetchPayloads("plant_notes"),
  ]);

  const [rEntries, rPlants, rNotes] = results;

  if (rEntries.status === "fulfilled") {
    const remoteEntries = rEntries.value || [];
    if (remoteEntries.length) saveEntriesToLocal(remoteEntries);
  }

  if (rPlants.status === "fulfilled") {
    const remotePlants = rPlants.value || [];
    if (remotePlants.length) savePlantsToLocal(remotePlants);
  }

  if (rNotes.status === "fulfilled") {
    const arr = rNotes.value || [];
    const remoteNotes = arr[0];
    if (remoteNotes && typeof remoteNotes === "object" && !Array.isArray(remoteNotes)) {
      if (Object.keys(remoteNotes).length) saveNotesToLocal(remoteNotes);
    }
  }

  const failed = results
    .map((r, i) => (r.status === "rejected" ? ["entries","plants","notes"][i] : null))
    .filter(Boolean);

  if (failed.length) {
    out(`âš ï¸ Supabase teilweise nicht geladen: ${failed.join(", ")}. Zeige lokale Daten.`);
  }
}

/* =========================================================
   9a) initApp (zeigt sofort local, lÃ¤dt dann Supabase)
   ========================================================= */
async function initApp() {
  console.log("ğŸš€ initApp gestartet");
  try {
    if (!supabaseClient) {
      out("âŒ Supabase SDK fehlt");
      console.error("supabaseClient ist null");
      if (typeof renderAll === "function") renderAll();
      return;
    }

    const session = await getSessionSafe();
    updateAuthUI(session);
    updateAdminUI();

    if (!session) {
  console.log("ğŸ”’ Kein Login -> local-only Mode");
  out("ğŸ”’ Lokalmodus (nicht eingeloggt). Ã„nderungen werden nach Login synchronisiert.");
  if (typeof renderAll === "function") renderAll();
  return;
      console.log("âœ… initApp fertig (local)");
      return;
    }

    // âœ… Sofort lokale Daten anzeigen (schnell!)
    out("âœ… Eingeloggt. Zeige lokale Datenâ€¦");
    renderAll();

    // â˜ï¸ Danach Supabase laden
    out("â˜ï¸ Lade Supabaseâ€¦");
    await initFromSupabase_FAST();

    out("âœ… Supabase geladen");
    renderAll();

    console.log("âœ… initApp fertig");
  } catch (e) {
    const name = e?.name || "";
    const msg = e?.message || String(e);

    if (name === "AbortError" || /aborted/i.test(msg)) {
      console.error("âš ï¸ initApp Abort (Safari):", name, msg, e);
      out("âš ï¸ Safari hat den Request abgebrochen. Bitte Seite neu laden.");
      if (typeof renderAll === "function") renderAll();
      return;
    }

    console.error("âŒ initApp Fehler:", name, msg, e);
    out("âŒ initApp Fehler: " + msg);
    if (typeof renderAll === "function") renderAll();
  }
}

// Auth-Events: wenn Magic Link â€œankommtâ€, neu laden
if (supabaseClient) {
  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    console.log("ğŸ”” Auth event:", event);
    updateAuthUI(session);

    if (event === "SIGNED_IN") {
  try {
    out("âœ… Login erkannt. Sync lokale Ã„nderungenâ€¦");

    // 1) Erst lokale Queue hochschieben (wenn etwas offen ist)
    await autoSyncAllIfDirty();

    // 2) Dann erst Supabase laden (jetzt ist Cloud aktuell)
    out("â¬‡ï¸ Lade Daten von Supabaseâ€¦");
    await initFromSupabase();

    renderAll();
    out("âœ… Alles synchronisiert.");
  } catch (e) {
    console.error("âŒ After-login sync/load error:", e);
    out("âŒ Fehler nach Login: " + (e?.message || e));
    renderAll();
  }
}



    if (event === "SIGNED_OUT") {
      out("ğŸ‘‹ Ausgeloggt. Zeige lokale Daten.");
      updateQueueStatusHint();
      if (typeof renderAll === "function") renderAll();
    }
  });
}

// Start
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initApp);
} else {
  initApp();
  updateQueueStatusHint();
}

/* =========================================================
   ADMIN-SCHUTZ (Supabase Aktionen nur fÃ¼r dich)
   ========================================================= */
const ADMIN_EMAILS = [
  "julia.salvamoser@web.de",
];

function normalizeEmail(s) {
  return String(s || "").trim().toLowerCase();
}

async function isAdminUser() {
  try {
    if (!supabaseClient) return false;
    const session = await getSessionSafe().catch(() => null);
    const email = normalizeEmail(session?.user?.email);
    if (!email) return false;
    return ADMIN_EMAILS.map(normalizeEmail).includes(email);
  } catch (e) {
    console.error("isAdminUser error:", e);
    return false;
  }
}

async function guardAdminOrWarn() {
  const ok = await isAdminUser();
  if (!ok) {
    out("ğŸ”’ Diese Supabase-Funktion ist nur fÃ¼r den Admin freigeschaltet.");
    alert("ğŸ”’ Diese Supabase-Funktion ist nur fÃ¼r den Admin freigeschaltet.");
    return false;
  }
  return true;
}

async function updateAdminUI() {
  const isAdmin = await isAdminUser();
  const b1 = document.getElementById("btnWipeSupabase");
  const b2 = document.getElementById("btnPushSupabase");
  const hint = document.getElementById("adminHintRow");
  if (b1) b1.style.display = isAdmin ? "" : "none";
  if (b2) b2.style.display = isAdmin ? "" : "none";
  if (hint) hint.style.display = isAdmin ? "none" : "";
}

/* =========================================================
   (Deine bestehenden Admin-Funktionen bleiben unverÃ¤ndert)
   ========================================================= */
async function wipeSupabaseData() {
  try {
    if (!(await guardAdminOrWarn())) return;
    if (!supabaseClient) throw new Error("supabaseClient fehlt");

    const session = await getSessionSafe().catch(() => null);
    if (!session) {
      out("ğŸ”’ Bitte einloggen, um Supabase lÃ¶schen zu kÃ¶nnen.");
      return;
    }

    const ok = confirm(
      "Wirklich ALLE aktuellen Supabase-Daten (entries, plants, plant_notes) fÃ¼r deinen Account lÃ¶schen?\n\n" +
      "Das betrifft nur DEINEN User (RLS)."
    );
    if (!ok) return;

    out("ğŸ§¨ LÃ¶sche Supabase-Datenâ€¦");
    await sbReplaceAll("entries", [], () => Date.now());
    await sbReplaceAll("plants", [], () => Date.now());
    await sbReplaceAll("plant_notes", [], () => Date.now());

    out("âœ… Supabase ist jetzt leer. Als nÃ¤chstes: Backup importieren.");
  } catch (e) {
    console.error("âŒ wipeSupabaseData Fehler:", e);
    out("âŒ LÃ¶schen fehlgeschlagen: " + (e?.message || e));
  }
}
window.wipeSupabaseData = wipeSupabaseData;

async function pushLocalToSupabase() {
  try {
    if (!(await guardAdminOrWarn())) return;
    if (!supabaseClient) throw new Error("supabaseClient fehlt");

    const session = await getSessionSafe().catch(() => null);
    if (!session) {
      out("ğŸ”’ Bitte einloggen, dann nochmal.");
      return;
    }

    const entries = loadEntriesFromLocal();
    const plants  = loadPlantsFromLocal();
    const notes   = loadNotesFromLocal();

    const ok = confirm(
      `Lokale Daten zu Supabase hochladen?\n\n` +
      `Entries: ${entries.length}\nPlants: ${plants.length}\nNotes: ${Object.keys(notes || {}).length}\n\n` +
      `Das Ã¼berschreibt den aktuellen Supabase-Stand (fÃ¼r deinen User).`
    );
    if (!ok) return;

    out("â˜ï¸ Upload: plantsâ€¦");
    await sbReplaceAll("plants", plants, () => Date.now());

    out("â˜ï¸ Upload: plant_notesâ€¦");
    await sbReplaceAll("plant_notes", [notes], () => Date.now());

    out("â˜ï¸ Upload: entriesâ€¦");
    await sbReplaceAll("entries", entries, (e) => e?.ts || Date.now());

    out("âœ… Lokale Daten sind jetzt in Supabase.");
    await initFromSupabase_FAST();
    renderAll();
  } catch (e) {
    console.error("âŒ pushLocalToSupabase Fehler:", e);
    out("âŒ Upload fehlgeschlagen: " + (e?.message || e));
  }
}
window.pushLocalToSupabase = pushLocalToSupabase;

/* =========================================================
   NORMALIZE PLANT + GETTERS
   ========================================================= */
function normalizePlant(p) {
  const name = String(p?.name || "").trim();
  if (!name) return null;
  const roomRaw = String(p?.room || "Wohnzimmer").trim();
  const room = ROOMS_ALL.includes(roomRaw) ? roomRaw : "Wohnzimmer";
  const active = p?.active === false ? false : true;
  return { name, room, active };
}

function getAllPlants() {
  return loadPlants();
}
function getActivePlants() {
  return loadPlants().filter((p) => p.active !== false && p.room !== REMOVED_ROOM);
}
function activePlantNames() {
  return getActivePlants().map((p) => p.name);
}

function getPlantNote(name) {
  const notes = loadPlantNotes();
  return String(notes?.[name] || "").trim();
}
function setPlantNote(name, text) {
  const notes = loadPlantNotes();
  const cleaned = String(text || "").trim();
  if (!cleaned) delete notes[name];
  else notes[name] = cleaned;
  savePlantNotes(notes);
}

function groupPlantsByRoom(plants) {
  const map = new Map();
  plants.forEach((p) => {
    const room = ROOMS_ALL.includes(p.room) ? p.room : "Wohnzimmer";
    if (!map.has(room)) map.set(room, []);
    map.get(room).push(p);
  });
  return ROOMS_ALL.map((r) => [
    r,
    (map.get(r) || []).sort((a, b) => a.name.localeCompare(b.name, "de")),
  ]);
}

/* =========================================================
   AGGREGATION
   ========================================================= */
function aggregateDay(entries, iso) {
  const res = {
    water: { snapshot: [], done: [] },
    fertilize: { snapshot: [], done: [] },
    comments: [],
  };

  const dayEntries = (entries || []).filter((e) => e && isoDate(e.ts) === iso);

  dayEntries.forEach((e) => {
    if (e.type === "batch") {
      if (e.action === "water") {
        res.water.snapshot = setUnion(res.water.snapshot, e.snapshot);
        res.water.done = setUnion(res.water.done, e.done);
      }
      if (e.action === "fertilize") {
        res.fertilize.snapshot = setUnion(res.fertilize.snapshot, e.snapshot);
        res.fertilize.done = setUnion(res.fertilize.done, e.done);
      }
    } else if (e.type === "comment") {
      res.comments.push({
        id: e.id,
        plant: e.plant || "Unbekannt",
        text: e.text || "",
        ts: e.ts,
        pinned: !!e.pinned,
      });
    }
  });

  res.water.snapshot = uniq(res.water.snapshot);
  res.water.done = uniq(res.water.done);
  res.fertilize.snapshot = uniq(res.fertilize.snapshot);
  res.fertilize.done = uniq(res.fertilize.done);

  res.comments.sort((a, b) => b.pinned - a.pinned || b.ts - a.ts);
  return res;
}

function buildCounts(entries) {
  const map = new Map();
  const days = uniq((entries || []).map((e) => isoDate(e.ts)));

  days.forEach((iso) => {
    const agg = aggregateDay(entries, iso);
    map.set(iso, {
      hasAny:
        (agg.water.done?.length || 0) > 0 ||
        (agg.fertilize.done?.length || 0) > 0 ||
        (agg.comments?.length || 0) > 0,
      waterDone: new Set(agg.water.done || []),
      fertDone: new Set(agg.fertilize.done || []),
      commentsCount: agg.comments.length || 0,
    });
  });

  return map;
}

/* =========================================================
   PLANTS DIALOG (MANAGE)
   ========================================================= */
function renderPlants() {
  const plants = getAllPlants();
  const list = document.getElementById("plantsList");
  if (!list) return;
  list.innerHTML = "";

  const grouped = groupPlantsByRoom(plants);

  grouped.forEach(([room, ps]) => {
    if (!ps.length) return;

    const header = document.createElement("div");
    header.className = "comment-item";
    header.innerHTML =
      `<b>ğŸ  ${escapeHtml(room)}</b>` +
      (room === REMOVED_ROOM
        ? `<div class="muted" style="margin-top:6px;">Diese Pflanzen bleiben fÃ¼r die Historie sichtbar.</div>`
        : "");
    list.appendChild(header);

    ps.forEach((pObj) => {
      const row = document.createElement("div");
      row.className = "plant-row";

      const left = document.createElement("div");
      const inactiveHint =
        pObj.active === false || pObj.room === REMOVED_ROOM ? " (entfernt)" : "";
      left.innerHTML = `<b>${escapeHtml(pObj.name)}${inactiveHint}</b>
        <div class="muted">ğŸ  ${escapeHtml(pObj.room)}</div>`;

      const actions = document.createElement("div");
      actions.className = "plant-actions";

      const renameBtn = document.createElement("button");
      renameBtn.className = "btn-ghost";
      renameBtn.textContent = "âœï¸";
      renameBtn.onclick = () => renamePlant(pObj.name);

      const roomBtn = document.createElement("button");
      roomBtn.className = "btn-ghost";
      roomBtn.textContent = "ğŸ ";
      roomBtn.onclick = () => openRoomDialog(pObj.name);

      const noteBtn = document.createElement("button");
      noteBtn.className = "btn-ghost";
      noteBtn.textContent = "ğŸ“";
      noteBtn.onclick = () => openPlantNote(pObj.name);

      const delBtn = document.createElement("button");
      delBtn.className = "btn-danger";
      delBtn.textContent = "ğŸ—‘ï¸";
      delBtn.onclick = () => removePlant(pObj.name);

      actions.append(noteBtn, roomBtn, renameBtn, delBtn);
      row.append(left, actions);
      list.appendChild(row);
    });
  });
}

function openPlants() {
  renderPlants();
  openDialog("plantsDialog");
}
function closePlants() {
  closeDialog("plantsDialog");
}

function addPlant() {
  const inp = document.getElementById("newPlant");
  const roomSel = document.getElementById("newRoom");

  const name = (inp?.value || "").trim();
  const room = (roomSel?.value || "Wohnzimmer").trim();
  if (!name) return;

  const plants = getAllPlants();
  if (plants.some((p) => p.name.toLowerCase() === name.toLowerCase())) {
    out("Diese Pflanze gibtâ€™s schon ğŸ™‚");
    return;
  }

  plants.unshift({
    name,
    room: ROOMS_BASE.includes(room) ? room : "Wohnzimmer",
    active: true,
  });

  savePlants(plants);

  if (inp) inp.value = "";
  if (roomSel) roomSel.value = "Wohnzimmer";

  out(`âœ… Pflanze hinzugefÃ¼gt: ${name} (${room})`);
  renderAll();
}

function renamePlant(oldName) {
  const newName = prompt(`Neuer Name fÃ¼r â€${oldName}â€œ:`, oldName);
  if (newName === null) return;
  const cleaned = newName.trim();
  if (!cleaned) return;

  const plants = getAllPlants();
  if (
    plants.some(
      (p) => p.name.toLowerCase() === cleaned.toLowerCase() && p.name !== oldName
    )
  ) {
    out("Name existiert schon ğŸ™‚");
    return;
  }

  const updatedPlants = plants.map((p) => (p.name === oldName ? { ...p, name: cleaned } : p));
  savePlants(updatedPlants);

  const entries = loadEntries().map((e) => renamePlantInEntry(e, oldName, cleaned));
  saveEntries(entries);

  const notes = loadPlantNotes();
  if (notes[oldName]) {
    notes[cleaned] = notes[oldName];
    delete notes[oldName];
    savePlantNotes(notes);
  }

  out(`âœ… Umbenannt: ${oldName} â†’ ${cleaned}`);
  renderAll();
}

function renamePlantInEntry(e, oldName, newName) {
  if (!e) return e;
  if (e.type === "batch") {
    const repl = (arr) =>
      Array.isArray(arr) ? arr.map((x) => (x === oldName ? newName : x)) : arr;
    return { ...e, snapshot: repl(e.snapshot), done: repl(e.done) };
  }
  if (e.type === "comment") {
    if (e.plant === oldName) return { ...e, plant: newName };
    return e;
  }
  return e;
}

/* =========================================================
   ROOM DIALOG
   ========================================================= */
function openRoomDialog(name) {
  pendingRoomPlant = name;
  const plants = getAllPlants();
  const current = plants.find((p) => p.name === name);

  const label = document.getElementById("roomPlantLabel");
  if (label) label.textContent = `Pflanze: ${name}`;

  const sel = document.getElementById("roomSelect");
  if (!sel) return;

  sel.innerHTML = "";
  ROOMS_ALL.forEach((r) => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    sel.appendChild(opt);
  });

  sel.value = ROOMS_ALL.includes(current?.room) ? current.room : "Wohnzimmer";
  openDialog("roomDialog");
}

function closeRoomDialog() {
  pendingRoomPlant = null;
  closeDialog("roomDialog");
}

function saveRoomDialog() {
  if (!pendingRoomPlant) return;
  const room = document.getElementById("roomSelect")?.value;

  const plants = getAllPlants();
  const updated = plants.map((p) => {
    if (p.name !== pendingRoomPlant) return p;
    const nextRoom = ROOMS_ALL.includes(room) ? room : "Wohnzimmer";
    const nextActive = nextRoom === REMOVED_ROOM ? false : true;
    return { ...p, room: nextRoom, active: nextActive };
  });

  savePlants(updated);

  out(`ğŸ  Raum gesetzt: ${pendingRoomPlant} â†’ ${room}`);
  closeRoomDialog();
  renderAll();
}

/* =========================================================
   DELETE PLANT DIALOG
   ========================================================= */
function removePlant(name) {
  const plants = getAllPlants();
  const activeCount = getActivePlants().length;
  const target = plants.find((p) => p.name === name);
  const isActive = target && target.active !== false && target.room !== REMOVED_ROOM;

  if (isActive && activeCount <= 1) {
    out("Mindestens 1 aktive Pflanze behalten ğŸ™‚");
    return;
  }
  pendingPlantToDelete = name;
  openDeletePlantDialog(name);
}

function openDeletePlantDialog(plantName) {
  const t = document.getElementById("deletePlantText");
  if (t) t.textContent = `Was soll mit der Historie von â€${plantName}â€œ passieren?`;
  openDialog("deletePlantDialog");
}
function closeDeletePlantDialog() {
  closeDialog("deletePlantDialog");
}
function deletePlantCancel() {
  pendingPlantToDelete = null;
  closeDeletePlantDialog();
  out("Abgebrochen â€“ nichts geÃ¤ndert.");
}
function deletePlantKeepHistory() {
  if (!pendingPlantToDelete) return;
  const name = pendingPlantToDelete;

  const plants = getAllPlants();
  const updated = plants.map((p) =>
    p.name !== name ? p : { ...p, room: REMOVED_ROOM, active: false }
  );
  savePlants(updated);

  pendingPlantToDelete = null;
  closeDeletePlantDialog();
  out(`âœ… â€${name}â€œ wurde zu â€${REMOVED_ROOM}â€œ verschoben (Historie bleibt).`);
  renderAll();
}

function removePlantFromEntry(e, name) {
  if (!e) return e;
  if (e.type === "batch") {
    const filt = (arr) => (Array.isArray(arr) ? arr.filter((x) => x !== name) : arr);
    const next = { ...e, snapshot: filt(e.snapshot), done: filt(e.done) };
    const doneLen = Array.isArray(next.done) ? next.done.length : 0;
    if (doneLen === 0) return null;
    return next;
  }
  if (e.type === "comment") return e.plant === name ? null : e;
  return e;
}

function deletePlantDeleteHistory() {
  if (!pendingPlantToDelete) return;
  const name = pendingPlantToDelete;

  savePlants(getAllPlants().filter((p) => p.name !== name));

  const entries = loadEntries();
  const cleaned = entries.map((e) => removePlantFromEntry(e, name)).filter((e) => e !== null);
  saveEntries(cleaned);

  setPlantNote(name, "");

  pendingPlantToDelete = null;
  closeDeletePlantDialog();
  out(`ğŸ—‘ï¸ Pflanze + Historie gelÃ¶scht: ${name}`);
  renderAll();
}

/* =========================================================
   PLANT NOTE (per plant)
   ========================================================= */
function openPlantNote(name) {
  pendingPlantForNote = name;
  const title = document.getElementById("plantNoteTitle");
  const ta = document.getElementById("plantNoteText");
  if (title) title.textContent = `ğŸ“ Pflanzenkommentar â€“ ${name}`;
  if (ta) ta.value = getPlantNote(name);
  openDialog("plantNoteDialog");
}
function closePlantNote() {
  pendingPlantForNote = null;
  closeDialog("plantNoteDialog");
}
function savePlantNote() {
  if (!pendingPlantForNote) return;
  const text = document.getElementById("plantNoteText")?.value || "";
  setPlantNote(pendingPlantForNote, text);
  out("ğŸ“ Pflanzenkommentar gespeichert âœ…");
  closePlantNote();
  renderAll();
}
function clearPlantNote() {
  if (!pendingPlantForNote) return;
  setPlantNote(pendingPlantForNote, "");
  const ta = document.getElementById("plantNoteText");
  if (ta) ta.value = "";
  out("ğŸ—‘ï¸ Pflanzenkommentar gelÃ¶scht.");
  renderAll();
}

/* =========================================================
   PLANT OVERVIEW
   ========================================================= */
function openPlantOverview() {
  renderPlantOverview();
  openDialog("plantOverviewDialog");
}
function closePlantOverview() {
  closeDialog("plantOverviewDialog");
}

function renderPlantOverview() {
  const wrap = document.getElementById("plantOverviewList");
  if (!wrap) return;
  wrap.innerHTML = "";

  const plants = getAllPlants();
  const grouped = groupPlantsByRoom(plants);

  grouped.forEach(([room, ps]) => {
    if (!ps.length) return;

    const card = document.createElement("div");
    card.className = "comment-item";
    card.innerHTML = `<b>ğŸ  ${escapeHtml(room)}</b>`;

    ps.forEach((p) => {
      const note = getPlantNote(p.name);
      const line = document.createElement("div");
      line.style.marginTop = "10px";
      line.innerHTML =
        `ğŸª´ <b>${escapeHtml(p.name)}</b>` +
        (note
          ? `<div class="muted" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(note)}</div>`
          : `<div class="muted" style="margin-top:6px;">(kein Pflanzenkommentar)</div>`);
      card.appendChild(line);
    });

    wrap.appendChild(card);
  });
}

function openPlantsFromOverview() {
  closeDialog("plantOverviewDialog");
  openPlants();
}

/* =========================================================
   HISTORY DIALOG
   ========================================================= */
function renderHistory(entries) {
  const historyEl = document.getElementById("history");
  if (!historyEl) return;
  historyEl.innerHTML = "";

  if (!(entries || []).length) {
    const li = document.createElement("li");
    li.textContent = "Noch keine EintrÃ¤ge.";
    historyEl.appendChild(li);
    return;
  }

  const days = uniq(entries.map((e) => isoDate(e.ts))).sort((a, b) => (a < b ? 1 : -1));
  const total = getActivePlants().length;

  days.forEach((iso) => {
    const agg = aggregateDay(entries, iso);
    const parts = [];
    parts.push(`ğŸŒ¿${total}`);
    if (agg.water.done.length) parts.push(`ğŸ’§${agg.water.done.length}`);
    if (agg.fertilize.done.length) parts.push(`ğŸ§ª${agg.fertilize.done.length}`);
    if (agg.comments.length) parts.push(`ğŸ“${agg.comments.length}`);

    const li = document.createElement("li");
    li.textContent = `${iso}: ${parts.join("  â€¢  ")}`;
    historyEl.appendChild(li);
  });
}

function openHistory() {
  renderAll();
  openDialog("historyDialog");
}
function closeHistory() {
  closeDialog("historyDialog");
}

/* =========================================================
   ACTION DIALOG (water/fertilize)
   ========================================================= */
function setActionDateToday() {
  const today = isoDate(new Date());
  const dateEl = document.getElementById("actionDate");
  if (dateEl) dateEl.value = today;
  actionISO = today;
  refreshActionListForDate();
}

function openActionWithDate(action, iso, lockDate = false) {
  pendingAction = action;

  const title = document.getElementById("actionTitle");
  if (title) {
    title.textContent =
      action === "water"
        ? "ğŸ’§ GieÃŸen â€“ welche Pflanzen?"
        : "ğŸ§ª DÃ¼ngen â€“ welche Pflanzen?";
  }

  actionISO = iso || isoDate(new Date());
  actionDateLocked = !!lockDate;

  const dateEl = document.getElementById("actionDate");
  if (dateEl) {
    dateEl.value = actionISO;
    dateEl.disabled = actionDateLocked;

    dateEl.onchange = () => {
      if (actionDateLocked) {
        dateEl.value = actionISO;
        return;
      }
      actionISO = dateEl.value || isoDate(new Date());
      refreshActionListForDate();
    };
  }

  const todayBtn = document.getElementById("actionDateTodayBtn");
  if (todayBtn) todayBtn.style.display = actionDateLocked ? "none" : "";

  refreshActionListForDate();
  openDialog("actionDialog");
}

function openAction(action) {
  openActionWithDate(action, isoDate(new Date()), true);
}
function openActionForSelectedDay(action) {
  openActionWithDate(action, state.selectedISO, true);
}

function refreshActionListForDate() {
  const entries = loadEntries();
  const agg = aggregateDay(entries, actionISO);
  const alreadyDone = pendingAction === "water" ? agg.water.done : agg.fertilize.done;

  const hint = document.getElementById("actionHint");
  if (hint) {
    hint.textContent = alreadyDone.length
      ? `Smart-Default: an diesem Datum schon geloggt (${alreadyDone.length}) ist abgewÃ¤hlt.`
      : "Smart-Default: alle Pflanzen sind ausgewÃ¤hlt.";
  }

  const list = document.getElementById("actionList");
  if (!list) return;
  list.innerHTML = "";

  const plants = getActivePlants();
  plants.forEach((pObj, idx) => {
    const row = document.createElement("label");
    row.className = "checkitem";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.plant = pObj.name;
    cb.id = "cb_" + idx;
    cb.checked = !alreadyDone.includes(pObj.name);

    const text = document.createElement("span");
    text.textContent = `${pObj.name} (${pObj.room || "Wohnzimmer"})`;

    row.append(cb, text);
    list.appendChild(row);
  });
}

function selectAllPlants() {
  document.querySelectorAll("#actionList input[type=checkbox]").forEach((cb) => (cb.checked = true));
}
function selectNonePlants() {
  document.querySelectorAll("#actionList input[type=checkbox]").forEach((cb) => (cb.checked = false));
}
function cancelAction() {
  pendingAction = null;
  closeDialog("actionDialog");
  out("Abgebrochen â€“ nichts gespeichert.");
}
function confirmAction() {
  if (!pendingAction) return;

  const selected = Array.from(document.querySelectorAll("#actionList input[type=checkbox]"))
    .filter((cb) => cb.checked)
    .map((cb) => cb.dataset.plant);

  if (selected.length === 0) {
    out("Keine Pflanzen ausgewÃ¤hlt ğŸ™‚");
    return;
  }

  const iso = actionISO || isoDate(new Date());
  const ts = isoToNoonTs(iso);
  const dateStr = new Date(ts).toLocaleDateString("de-DE");

  const entries = loadEntries();
  const idx = entries.findIndex(
    (e) => e && e.type === "batch" && e.action === pendingAction && isoDate(e.ts) === iso
  );

  const snapshot = activePlantNames();

  if (idx >= 0) {
    const existing = entries[idx];
    entries[idx] = {
      ...existing,
      ts,
      date: dateStr,
      snapshot: setUnion(existing.snapshot, snapshot),
      done: setUnion(existing.done, selected),
    };
  } else {
    entries.unshift({
      type: "batch",
      action: pendingAction,
      ts,
      date: dateStr,
      snapshot: uniq(snapshot),
      done: uniq(selected),
    });
  }

  saveEntries(entries);

  out(
    `${pendingAction === "water" ? "ğŸ’§" : "ğŸ§ª"} gespeichert fÃ¼r ${iso
      .split("-")
      .reverse()
      .join(".")}: ${selected.length} Pflanze(n) âœ…`
  );

  state.selectedISO = iso;
  pendingAction = null;
  closeDialog("actionDialog");
  renderAll();
}

  // ==========================
  // COMMENTS (today + per day popup)
  // ==========================
  function fillCommentPlants(selectElId, includeRemoved = true) {
    const plants = includeRemoved ? getAllPlants() : getActivePlants();
    const sel = document.getElementById(selectElId);
    if (!sel) return;
    sel.innerHTML = "";

    // âœ… Allgemein-Option ganz oben
    const optGeneral = document.createElement("option");
    optGeneral.value = GENERAL_COMMENT_KEY;
    optGeneral.textContent = "ğŸ—’ï¸ Allgemein (Tageskommentar)";
    sel.appendChild(optGeneral);

    plants.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.name;
      const removedTag =
        p.room === REMOVED_ROOM || p.active === false ? " â€¢ entfernt" : "";
      opt.textContent = `${p.name} (${p.room})${removedTag}`;
      sel.appendChild(opt);
    });
  }

  function saveCommentForISO(iso, plant, text, pinned) {
    const ts = isoToNoonTs(iso);
    const entry = {
      type: "comment",
      id: uuid(),
      ts,
      date: new Date(ts).toLocaleDateString("de-DE"),
      plant,
      text,
      pinned: !!pinned,
    };
    const entries = loadEntries();
    entries.unshift(entry);
    saveEntries(entries);
  }

  function openCommentToday() {
    fillCommentPlants("commentPlant", true);
    const ta = document.getElementById("commentText");
    const pin = document.getElementById("commentPinned");
    if (ta) ta.value = "";
    if (pin) pin.checked = false;
    openDialog("commentDialog");
  }

  function closeComment() {
    closeDialog("commentDialog");
  }

  function saveCommentToday() {
    const plant = (document.getElementById("commentPlant")?.value || "").trim();
    const text = (document.getElementById("commentText")?.value || "").trim();
    const pinned = !!document.getElementById("commentPinned")?.checked;

    if (!plant) return out("Bitte eine Pflanze auswÃ¤hlen ğŸ™‚");
    if (!text) return out("Bitte einen Kommentar eingeben ğŸ™‚");

    const iso = isoDate(new Date());
    saveCommentForISO(iso, plant, text, pinned);

    state.selectedISO = iso;
    out("ğŸ“ Kommentar gespeichert âœ…");
    closeComment();
    renderAll();
  }

  // ==========================
  // DAY COMMENTS POPUP (badge)
  // ==========================
  function openDayCommentsFromBadge(evt, iso) {
    if (evt) evt.stopPropagation();
    openDayComments(iso);
  }

  function openDayComments(iso) {
    popupISO = iso;

    const title = document.getElementById("dayCommentsTitle");
    if (title)
      title.textContent = `ğŸ“ Kommentare â€“ ${iso.split("-").reverse().join(".")}`;

    fillCommentPlants("popupCommentPlant", true);

    const ta = document.getElementById("popupCommentText");
    const pin = document.getElementById("popupCommentPinned");
    if (ta) ta.value = "";
    if (pin) pin.checked = false;

    renderDayCommentsPopup();
    openDialog("dayCommentsDialog");
  }

  function closeDayComments() {
    popupISO = null;
    closeDialog("dayCommentsDialog");
  }

  function renderDayCommentsPopup() {
    const wrap = document.getElementById("dayCommentsList");
    if (!wrap) return;
    wrap.innerHTML = "";
    if (!popupISO) return;

    const entries = loadEntries();
    const agg = aggregateDay(entries, popupISO);

    if (!agg.comments.length) {
      const p = document.createElement("p");
      p.className = "muted";
      p.textContent = "Noch keine Kommentare an diesem Tag.";
      wrap.appendChild(p);
      return;
    }

    agg.comments.forEach((c) => {
      const box = document.createElement("div");
      box.className = "comment-item" + (c.pinned ? " pinned" : "");

      const header = document.createElement("div");
      header.className = "comment-header";

      const left = document.createElement("div");
      left.innerHTML = `ğŸª´ <b>${escapeHtml(c.plant)}</b>${
        c.pinned ? " <span class='pill'>ğŸ“Œ</span>" : ""
      }`;

      const actions = document.createElement("div");
      actions.className = "comment-actions";

      const pinBtn = document.createElement("button");
      pinBtn.className = "btn-ghost";
      pinBtn.textContent = c.pinned ? "ğŸ“Œâœ“" : "ğŸ“Œ";
      pinBtn.onclick = () => togglePinComment(c.id);

      const editBtn = document.createElement("button");
      editBtn.className = "btn-ghost";
      editBtn.textContent = "âœï¸";
      editBtn.onclick = () => editComment(c.id);

      const delBtn = document.createElement("button");
      delBtn.className = "btn-danger";
      delBtn.textContent = "ğŸ—‘ï¸";
      delBtn.onclick = () => deleteComment(c.id);

      actions.append(pinBtn, editBtn, delBtn);
      header.append(left, actions);

      const text = document.createElement("div");
      text.className = "comment-text";
      text.textContent = c.text;

      box.append(header, text);
      wrap.appendChild(box);
    });
  }

  function savePopupComment() {
    if (!popupISO) return;

    const plant = (document.getElementById("popupCommentPlant")?.value || "").trim();
    const text = (document.getElementById("popupCommentText")?.value || "").trim();
    const pinned = !!document.getElementById("popupCommentPinned")?.checked;

    if (!plant) return out("Bitte eine Pflanze auswÃ¤hlen ğŸ™‚");
    if (!text) return out("Bitte einen Kommentar eingeben ğŸ™‚");

    saveCommentForISO(popupISO, plant, text, pinned);

    const ta = document.getElementById("popupCommentText");
    const pin = document.getElementById("popupCommentPinned");
    if (ta) ta.value = "";
    if (pin) pin.checked = false;

    out("ğŸ“ Kommentar gespeichert âœ…");
    renderAll();
    renderDayCommentsPopup();
    renderDayViewPopup();
  }

  function editComment(id) {
    const entries = loadEntries();
    const idx = entries.findIndex((e) => e && e.type === "comment" && e.id === id);
    if (idx < 0) return;

    const current = entries[idx];
    const newText = prompt(
      `Kommentar fÃ¼r ${current.plant} bearbeiten:`,
      current.text || ""
    );
    if (newText === null) return;

    const cleaned = String(newText).trim();
    if (!cleaned) return alert("Kommentar darf nicht leer sein.");

    entries[idx] = { ...current, text: cleaned };
    saveEntries(entries);

    out("ğŸ“ Kommentar aktualisiert âœ…");
    renderAll();
    if (popupISO) renderDayCommentsPopup();
    renderDayViewPopup();
  }

  function deleteComment(id) {
    if (!confirm("Kommentar wirklich lÃ¶schen?")) return;
    const entries = loadEntries().filter(
      (e) => !(e && e.type === "comment" && e.id === id)
    );
    saveEntries(entries);

    out("ğŸ—‘ï¸ Kommentar gelÃ¶scht.");
    renderAll();
    if (popupISO) renderDayCommentsPopup();
    renderDayViewPopup();
  }

  function togglePinComment(id) {
    const entries = loadEntries();
    const idx = entries.findIndex((e) => e && e.type === "comment" && e.id === id);
    if (idx < 0) return;

    entries[idx] = { ...entries[idx], pinned: !entries[idx].pinned };
    saveEntries(entries);

    renderAll();
    if (popupISO) renderDayCommentsPopup();
    renderDayViewPopup();
  }

  // ==========================
  // DAY VIEW DIALOG
  // ==========================
  function openDayView(iso) {
    state.selectedISO = iso;

    const title = document.getElementById("dayViewTitle");
    if (title)
      title.textContent = `ğŸ“… Tagesansicht â€“ ${iso.split("-").reverse().join(".")}`;

    fillCommentPlants("dayPopupCommentPlant", true);

    const ta = document.getElementById("dayPopupCommentText");
    const pin = document.getElementById("dayPopupCommentPinned");
    if (ta) ta.value = "";
    if (pin) pin.checked = false;

    renderDayViewPopup();
    openDialog("dayViewDialog");
  }

  function closeDayView() {
    closeDialog("dayViewDialog");
  }

  function pillMini(text, cls) {
    return `<span class="pill-mini ${cls}">${text}</span>`;
  }

  function renderDayViewPopup() {
    const body = document.getElementById("dayViewBody");
    if (!body) return;
    body.innerHTML = "";

    const entries = loadEntries();
    const iso = state.selectedISO;
    const agg = aggregateDay(entries, iso);

    const waterDone = new Set(agg.water.done || []);
    const fertDone = new Set(agg.fertilize.done || []);

    // âœ… Kommentare trennen: Allgemein vs. pro Pflanze
    const generalComments = [];
    const commentsMap = new Map();

    (agg.comments || []).forEach((c) => {
      const plant = c.plant || "Unbekannt";

      if (plant === GENERAL_COMMENT_KEY) {
        generalComments.push(c);
        return;
      }

      if (!commentsMap.has(plant)) commentsMap.set(plant, []);
      commentsMap.get(plant).push(c);
    });

    function statusPillsFor(name) {
      const pills = [];
      if (waterDone.has(name)) pills.push(pillMini("ğŸ’§", "water"));
      if (fertDone.has(name)) pills.push(pillMini("ğŸ§ª", "fert"));
      const cc = (commentsMap.get(name) || []).length;
      if (cc) pills.push(pillMini(`ğŸ“${cc}`, "note"));
      if (!waterDone.has(name) && !fertDone.has(name))
        pills.unshift(pillMini("â€”", "none"));
      return pills.join("");
    }

    function commentsHtmlFor(name) {
      const arr = commentsMap.get(name) || [];
      if (!arr.length) return "";
      return `
        <div class="muted" style="margin-top:6px;">
          ${arr
            .map((c) => {
              const pin = c.pinned
                ? " <span class='pill' style='transform:translateY(-1px);'>ğŸ“Œ</span>"
                : "";
              return `
                <div style="margin-top:6px; white-space:pre-wrap;">
                  ${pin}${escapeHtml(c.text)}
                </div>
              `;
            })
            .join("")}
        </div>
      `;
    }

    const all = getAllPlants();
    const active = all.filter((p) => p.active !== false && p.room !== REMOVED_ROOM);
    const removed = all.filter((p) => p.room === REMOVED_ROOM || p.active === false);

    const activeGrouped = groupPlantsByRoom(active);

    // ğŸ—’ï¸ Allgemeine Tageskommentare ganz oben anzeigen
    if (generalComments.length) {
      const box = document.createElement("div");
      box.className = "comment-item";
      box.innerHTML = `<b>ğŸ—’ï¸ Allgemeiner Tageskommentar</b>`;

      generalComments.forEach((c) => {
        const item = document.createElement("div");
        item.style.marginTop = "10px";
        item.innerHTML =
          `${c.pinned ? "<span class='pill'>ğŸ“Œ</span> " : ""}` +
          `<div class="muted" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(
            c.text
          )}</div>`;
        box.appendChild(item);
      });

      body.appendChild(box);
    }

    // âœ… Aktive Pflanzen: pro Pflanze Status + Kommentare direkt darunter
    activeGrouped.forEach(([room, ps]) => {
      if (room === REMOVED_ROOM) return;
      if (!ps.length) return;

      const roomCard = document.createElement("div");
      roomCard.className = "comment-item";
      roomCard.innerHTML = `<b>ğŸ  ${escapeHtml(room)}</b>`;

      ps.forEach((p) => {
        const line = document.createElement("div");
        line.style.marginTop = "10px";

        line.innerHTML = `
          ğŸª´ <b>${escapeHtml(p.name)}</b>
          <div class="status-pills">${statusPillsFor(p.name)}</div>
          ${commentsHtmlFor(p.name)}
        `;

        roomCard.appendChild(line);
      });

      body.appendChild(roomCard);
    });

    // Entfernte Pflanzen nur wenn an dem Tag relevant
    const relevantNames = new Set(
      [
        ...(agg.water.snapshot || []),
        ...(agg.fertilize.snapshot || []),
        ...(agg.water.done || []),
        ...(agg.fertilize.done || []),
        ...(agg.comments || []).map((c) => c.plant),
      ].filter(Boolean)
    );

    const removedRelevant = removed
      .filter((p) => relevantNames.has(p.name))
      .sort((a, b) => a.name.localeCompare(b.name, "de"));

    if (removedRelevant.length) {
      const roomCard = document.createElement("div");
      roomCard.className = "comment-item";
      roomCard.innerHTML = `<b>ğŸšï¸ ${escapeHtml(REMOVED_ROOM)}</b>
        <div class="muted" style="margin-top:6px;">
          Diese Pflanzen wurden entfernt, werden aber fÃ¼r die Historie angezeigt.
        </div>`;

      removedRelevant.forEach((p) => {
        const line = document.createElement("div");
        line.style.marginTop = "10px";

        line.innerHTML = `
          ğŸª´ <b>${escapeHtml(p.name)}</b>
          <div class="status-pills">${statusPillsFor(p.name)}</div>
          ${commentsHtmlFor(p.name)}
        `;

        roomCard.appendChild(line);
      });

      body.appendChild(roomCard);
    }

    // âœ… Sammelblock "Kommentare" am Ende bewusst entfernt
  }

  function saveDayCommentFromPopup() {
    const plant = (document.getElementById("dayPopupCommentPlant")?.value || "").trim();
    const text = (document.getElementById("dayPopupCommentText")?.value || "").trim();
    const pinned = !!document.getElementById("dayPopupCommentPinned")?.checked;

    if (!plant) return out("Bitte eine Pflanze auswÃ¤hlen ğŸ™‚");
    if (!text) return out("Bitte einen Kommentar eingeben ğŸ™‚");

    const iso = state.selectedISO;
    saveCommentForISO(iso, plant, text, pinned);

    const ta = document.getElementById("dayPopupCommentText");
    const pin = document.getElementById("dayPopupCommentPinned");
    if (ta) ta.value = "";
    if (pin) pin.checked = false;

    out("ğŸ“ Kommentar zum Tag gespeichert âœ…");
    renderAll();
    if (popupISO) renderDayCommentsPopup();
    renderDayViewPopup();
  }
    // ==========================
      // CALENDAR
      // ==========================
      function renderCalendar(entries) {
        const cal = document.getElementById("calendar");
        const title = document.getElementById("monthTitle");
        if (!cal || !title) return;

        cal.innerHTML = "";

        const base = new Date(
          state.viewMonth.getFullYear(),
          state.viewMonth.getMonth(),
          1
        );

        title.textContent = base.toLocaleString("de-DE", {
          month: "long",
          year: "numeric",
        });

        const start = new Date(base);
        const weekday = (start.getDay() + 6) % 7; // Mo=0
        start.setDate(start.getDate() - weekday);

        const counts = buildCounts(entries);
        const todayISO = isoDate(new Date());
        const labels = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];

        labels.forEach((l) => {
          const head = document.createElement("div");
          head.className = "cal-head";
          head.textContent = l;
          cal.appendChild(head);
        });

        const total = getActivePlants().length;

        for (let i = 0; i < 42; i++) {
          const d = new Date(start);
          d.setDate(start.getDate() + i);
          const iso = isoDate(d);

          const cell = document.createElement("button");
          cell.className = "day-btn";

          if (d.getMonth() !== base.getMonth()) cell.style.opacity = "0.35";
          if (iso === todayISO) cell.classList.add("today");
          if (iso === state.selectedISO) cell.classList.add("selected");

          const c = counts.get(iso);

          const badges = [];
          badges.push({ cls: "b-total", text: `ğŸŒ¿${total}` });

          if (c?.hasAny) {
            if (c?.waterDone?.size)
              badges.push({ cls: "b-water", text: `ğŸ’§${c.waterDone.size}` });
            if (c?.fertDone?.size)
              badges.push({ cls: "b-fert", text: `ğŸ§ª${c.fertDone.size}` });
            if (c?.commentsCount)
              badges.push({
                cls: "b-comment comment-badge big-comment",
                text: `ğŸ“${c.commentsCount}`,
                isComment: true,
              });
          }

          const isToday = iso === todayISO;
          cell.innerHTML = `
        <div style="font-weight:900; font-size:16px;">
          ${d.getDate()}
          ${isToday ? `<span class="today-chip">âœ¨ Heute</span>` : ``}
        </div>
        <div class="badges">
          ${badges
            .map((b) => {
              if (b.isComment) {
                return `<span class="badge ${b.cls}" onclick="openDayCommentsFromBadge(event,'${iso}')">${b.text}</span>`;
              }
              return `<span class="badge ${b.cls}">${b.text}</span>`;
            })
            .join("")}
        </div>
      `;

          cell.onclick = () => openDayView(iso);
          cal.appendChild(cell);
        }
      }

      function prevMonth() {
        state.viewMonth = new Date(
          state.viewMonth.getFullYear(),
          state.viewMonth.getMonth() - 1,
          1
        );
        renderAll();
      }

      function nextMonth() {
        state.viewMonth = new Date(
          state.viewMonth.getFullYear(),
          state.viewMonth.getMonth() + 1,
          1
        );
        renderAll();
      }

      // ==========================
      // CLEAR ALL
      // ==========================
      function clearAll() {
        if (!confirm("Wirklich alle EintrÃ¤ge lÃ¶schen?")) return;
        localStorage.removeItem(STORAGE_KEY);
        out("Alle EintrÃ¤ge gelÃ¶scht.");
        renderAll();

        // OPTIONAL: wenn du Supabase als Source-of-Truth nutzt, kannst du hier auch remote lÃ¶schen.
        // Lass das nur aktiv, wenn du wirklich ALLES remote weg haben willst.
        // (Wenn du schon Funktionen dafÃ¼r hast, hier einhÃ¤ngen.)
        // scheduleSupabaseSync(loadEntries()); // oder: replaceAllEntriesInSupabase([])
      }

      // ==========================
      // RENDER ALL
      // ==========================
      function renderAll() {
        loadPlants(); // ensures defaults exist
        renderPlants();

        const entries = loadEntries();
        renderHistory(entries);
        renderCalendar(entries);

        if (popupISO) renderDayCommentsPopup();
        try {
          fillCommentPlants("dayPopupCommentPlant", true);
        } catch {}
      }
      // ==========================
      // Import/export Localfiles"
      // ==========================

function exportLocalData() {
  try {
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      keys: {
        entries: STORAGE_KEY,
        plants: PLANTS_KEY,
        notes: PLANT_NOTES_KEY,
      },
      data: {
        entries: loadEntriesFromLocal(),
        plants: loadPlantsFromLocal(),
        notes: loadNotesFromLocal(),
      },
    };

    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `pflanzenlog-backup-${isoDate(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
    out("âœ… Backup exportiert.");
  } catch (e) {
    console.error("âŒ exportLocalData Fehler:", e);
    out("âŒ Export fehlgeschlagen: " + (e?.message || e));
  }
}

async function importLocalData(file) {
  if (!file) return;

  try {
    const text = await file.text();
    const payload = JSON.parse(text);

    // Akzeptiere sowohl dein strukturiertes Backup (payload.data.*)
    // als auch "raw" Formate, falls du mal nur arrays/objekte exportierst.
    const entries = payload?.data?.entries ?? payload?.entries ?? [];
    const plants  = payload?.data?.plants  ?? payload?.plants  ?? [];
    const notes   = payload?.data?.notes   ?? payload?.notes   ?? {};

    if (!Array.isArray(entries)) throw new Error("Import: entries ist kein Array");
    if (!Array.isArray(plants)) throw new Error("Import: plants ist kein Array");
    if (typeof notes !== "object" || notes === null || Array.isArray(notes)) {
      throw new Error("Import: notes ist kein Objekt");
    }

    // 1) Lokal speichern
    saveEntriesToLocal(entries);
    savePlantsToLocal(plants);
    saveNotesToLocal(notes);

    out(`âœ… Import ok: ${entries.length} EintrÃ¤ge, ${plants.length} Pflanzen.`);
    console.log("âœ… Import ok", { entries: entries.length, plants: plants.length });

    // 2) UI aktualisieren
    if (typeof renderAll === "function") renderAll();

    // 3) OPTIONAL: direkt zu Supabase syncen, wenn eingeloggt
    if (supabaseClient) {
      const session = await getSessionSafe().catch(() => null);
      if (session) {
        out("â˜ï¸ Import erkannt â€“ sync zu Supabaseâ€¦");
        // Wichtig: saveX triggert deine Debounce-Sync-Strategie
        savePlants(plants);
        savePlantNotes(notes);
        saveEntries(entries);
        out("âœ… Import + Sync angestoÃŸen (Supabase).");
      } else {
        out("â„¹ï¸ Import ok. FÃ¼r Supabase Sync bitte einloggen.");
      }
    }
  } catch (e) {
    console.error("âŒ importLocalData Fehler:", e);
    out("âŒ Import fehlgeschlagen: " + (e?.message || e));
  }
}  
      // ==========================
// Topbar MenÃ¼s (User / Settings)
// ==========================
function openUserMenu() {
  // Email vom alten Feld Ã¼bernehmen (falls vorhanden)
  const e1 = document.getElementById("emailInput")?.value || "";
  const e2 = document.getElementById("emailInput2");
  if (e2 && !e2.value) e2.value = e1;

  // Status spiegeln
  const s1 = document.getElementById("authStatus")?.textContent || "Nicht eingeloggt";
  const s2 = document.getElementById("authStatus2");
  if (s2) s2.textContent = s1;

  openDialog("userMenuDialog");
}
function closeUserMenu() {
  closeDialog("userMenuDialog");
}

async function openSettingsMenu() {
  await updateAdminUI();
  openDialog("settingsMenuDialog");
}

function closeSettingsMenu() {
  closeDialog("settingsMenuDialog");
}

async function sendMagicLinkFromUserMenu() {
  // Wert aus userMenu -> in das originale Feld, damit deine bestehende Funktion weiter arbeitet
  const e2 = (document.getElementById("emailInput2")?.value || "").trim();
  const e1 = document.getElementById("emailInput");
  if (e1) e1.value = e2;
  await sendMagicLink();
}

// Auth UI: beide Labels aktuell halten
const _oldUpdateAuthUI = updateAuthUI;
updateAuthUI = function(session) {
  _oldUpdateAuthUI(session);
  const s2 = document.getElementById("authStatus2");
  if (s2) {
    s2.textContent = session?.user
      ? `Eingeloggt: ${session.user.email || session.user.id}`
      : "Nicht eingeloggt";
  }
};

// optional: altes Auth-Card ausblenden (damit es nicht doppelt ist)
(function hideOldAuthCard() {
  const c = document.getElementById("authCard");
  if (c) c.style.display = "none";
})();
      // ==========================
      // EXPORT FOR inline onclick=""
      // ==========================
 
      window.openAction = openAction;
      window.openActionWithDate = openActionWithDate;
      window.openActionForSelectedDay = openActionForSelectedDay;

      window.setActionDateToday = setActionDateToday;
      window.selectAllPlants = selectAllPlants;
      window.selectNonePlants = selectNonePlants;
      window.cancelAction = cancelAction;
      window.confirmAction = confirmAction;

      window.openCommentToday = openCommentToday;
      window.closeComment = closeComment;
      window.saveCommentToday = saveCommentToday;

      window.saveDayCommentFromPopup = saveDayCommentFromPopup;

      window.openDayCommentsFromBadge = openDayCommentsFromBadge;
      window.openDayComments = openDayComments;
      window.closeDayComments = closeDayComments;
      window.savePopupComment = savePopupComment;

      window.openDayView = openDayView;
      window.closeDayView = closeDayView;

      window.editComment = editComment;
      window.deleteComment = deleteComment;
      window.togglePinComment = togglePinComment;

      window.prevMonth = prevMonth;
      window.nextMonth = nextMonth;

      window.openHistory = openHistory;
      window.closeHistory = closeHistory;

      window.openPlants = openPlants;
      window.closePlants = closePlants;

      window.addPlant = addPlant;
      window.renamePlant = renamePlant;
      window.removePlant = removePlant;

      window.openRoomDialog = openRoomDialog;
      window.closeRoomDialog = closeRoomDialog;
      window.saveRoomDialog = saveRoomDialog;

      window.deletePlantCancel = deletePlantCancel;
      window.deletePlantDeleteHistory = deletePlantDeleteHistory;
      window.deletePlantKeepHistory = deletePlantKeepHistory;

      window.openPlantOverview = openPlantOverview;
      window.closePlantOverview = closePlantOverview;

      window.openPlantNote = openPlantNote;
      window.closePlantNote = closePlantNote;
      window.savePlantNote = savePlantNote;
      window.clearPlantNote = clearPlantNote;

      window.clearAll = clearAll;
      window.exportLocalData = exportLocalData;
      window.importLocalData = importLocalData;
      window.sendMagicLink = sendMagicLink;
      window.logout = logout;
      window.openUserMenu = openUserMenu;
      window.closeUserMenu = closeUserMenu;
      window.openSettingsMenu = openSettingsMenu;
      window.closeSettingsMenu = closeSettingsMenu;
      window.sendMagicLinkFromUserMenu = sendMagicLinkFromUserMenu;
      window.openPlantsFromOverview = openPlantsFromOverview;
      
</script>
  </body>
</html>
